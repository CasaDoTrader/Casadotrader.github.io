<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Casa do Trader</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
<style>:root{--bg:#0a0a1f;--card:rgba(20,20,40,.95);--cyan:#00f2ff;--gold:#FFD700;--pink:#ff00ff;--green:#00ff88;--red:#ff2d55;--text:#e0e0ff}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Rajdhani,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center;background-image:radial-gradient(circle at 20% 80%,rgba(0,242,255,.08)0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,215,0,.08)0%,transparent 50%)}.card{max-width:390px;width:90%;background:var(--card);border-radius:20px;padding:28px 20px;border:1px solid rgba(255,215,0,.25);box-shadow:0 15px 40px rgba(255,215,0,.2),0 0 30px rgba(0,242,255,.15);position:relative;overflow:hidden}.card::before{content:"";position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--cyan),var(--gold),var(--pink))}.logo{font-size:56px;font-weight:900;background:linear-gradient(45deg,var(--cyan),var(--gold),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}.title{font-size:28px;color:#fff;margin:8px 0 20px;letter-spacing:1px}.price{font-size:42px;color:var(--gold);text-shadow:0 0 15px rgba(255,215,0,.6);margin:16px 0;font-weight:800}.off{color:var(--green);font-size:20px;font-weight:700}.btn{display:block;width:100%;padding:16px;border-radius:14px;font-weight:800;font-size:18px;margin:14px 0;border:none;cursor:pointer;transition:.3s}.buy{background:#25d366;color:#fff;box-shadow:0 8px 20px rgba(37,211,100,.5)}.buy:hover{transform:scale(1.04)}.gold{background:var(--gold);color:#000}.green{background:var(--green);color:#000}.red{background:var(--red);color:#fff;font-size:14px;padding:8px}.input{width:100%;padding:14px;margin:10px 0;border-radius:12px;background:rgba(42,42,45,.9);border:1px solid rgba(255,215,0,.3);color:#fff;font-size:16px;outline:none;text-align:center}.orbit{width:90px;height:90px;margin:24px auto;position:relative}.e{position:absolute;width:14px;height:14px;border-radius:50%;background:var(--cyan);box-shadow:0 0 20px currentColor;animation:orbit 2.8s linear infinite,color 4s infinite}@keyframes orbit{0%{transform:rotate(0deg) translateX(45px)}100%{transform:rotate(360deg) translateX(45px)}}@keyframes color{0%,100%{background:var(--cyan)}25%{background:var(--pink)}50%{background:var(--green)}75%{background:var(--gold)}}table{width:100%;margin-top:12px;font-size:14px;border-collapse:collapse}th,td{padding:8px;text-align:left}th{background:rgba(42,42,45,.8)}tr:nth-child(even){background:rgba(34,34,34,.5)}.hidden{display:none}.msg{color:var(--green);margin:10px 0;min-height:24px;font-size:15px}.err{color:var(--red)}small a{color:var(--gold);text-decoration:none}small a:hover{text-decoration:underline}</style>
</head>
<body>

<div id="main" class="card">
  <div class="logo">ÁTOMOS</div>
  <div class="title">ATOMIC 2026</div>
  <div class="orbit"><div class="e"></div><div class="e" style="animation-delay:-0.9s"></div><div class="e" style="animation-delay:-1.8s"></div></div>
  <input id="nome" class="input" placeholder="Digite seu nome" autofocus>
  <input id="senhaCli" type="password" class="input" placeholder="Sua senha (opcional)">
  <button class="btn buy" id="btnEntrar">ENTRAR NA REDE</button>
  <div class="msg err" id="msg"></div>
  <p style="margin:20px 0;line-height:1.6">1 Átomo = 100 Elétrons<br><span class="off">50% DE DESCONTO</span></p>
  <div class="price">R$ 100,00</div>
  <a href="https://wa.me/558599522997?text=Quero%201%20%C3%81tomo%20ATOMIC%20por%20R$100%20(50%25%20OFF)%20%F0%9F%94%A5%F0%9F%92%A5" target="_blank" class="btn buy">COMPRAR AGORA COM O PIX</a>
  <p style="margin:20px 0;font-size:15px">Venda Mínima Entre Clientes <b>R$ 2,00</b>/elétron<br>Taxa de: <b>10%</b></p>
  <small><a href="#" id="linkAdmin">ÁREA RESTRITA</a></small>
</div>

<div id="adminLogin" class="card hidden"><h2 style="color:var(--gold)">Área Admin</h2><input id="admUser" class="input" value="adm"><input id="admPass" type="password" class="input" placeholder="Senha"><button class="btn green" id="btnLoginAdm">ENTRAR</button><div id="admMsg" class="msg err"></div></div>

<div id="painel" class="card hidden">
  <h2 style="color:var(--green)">Painel Admin</h2>
  <p>Saldo Lucro: R$ <b id="saldoAdm">0,00</b><br>
  Saldo Insumos: R$ <b id="saldoInsumos">0,00</b> • <a href="#" id="linkTrocarSenhaAdm" style="color:var(--cyan)">Trocar senha</a></p>
  <hr style="margin:20px 0;border:1px solid #333">
<h3 style="color:var(--cyan)">Comprar Insumos</h3>
<input id="valorInsumo" type="number" step="0.01" class="input" placeholder="Valor do Insumo (R$)">
<button class="btn red" id="btnComprarInsumo">COMPRAR INSUMO</button>
  <hr style="margin:20px 0;border:1px solid #333">
  <h3 style="color:var(--pink)">Trocas Físicas Pendentes</h3>
  <div id="listaTrocas" style="max-height:200px;overflow:auto"></div>
  <button class="btn gold" id="btnSacarAdm">SACAR TUDO</button>
  <hr style="margin:20px 0;border:1px solid #333">
  <h3 style="color:var(--gold)">Saques Pendentes</h3>
  <div id="saquesPendentes" style="max-height:300px;overflow:auto;padding:10px;background:rgba(20,0,0,.3);border-radius:10px"></div>
  <hr style="margin:20px 0;border:1px solid #333">
  <input id="lucroTotal" type="number" step="0.01" class="input" placeholder="Lucro total recebido (R$)">
  <button class="btn green" id="btnDistribuir">DISTRIBUIR 75%</button><div id="distMsg" class="msg"></div>
  <hr style="margin:20px 0">
  <h3>Adicionar Cliente</h3><input id="newNome" class="input" placeholder="Nome"><input id="newAtom" type="number" class="input" placeholder="Átomos"><button class="btn green" id="btnAddCliente">ADICIONAR</button>
  <h3 style="margin-top:20px">Retirar Elétrons → Loja</h3><input id="retNome" class="input" placeholder="Nome"><input id="retQtd" type="number" class="input" placeholder="Elétrons"><button class="btn red" id="btnRetirar">RETIRAR</button><div id="retMsg" class="msg err"></div>
  <h3 style="margin-top:20px">Clientes</h3><div style="max-height:200px;overflow:auto"><table id="tabela"><tr><th>Nome</th><th>Elétrons</th><th>Saldo R$</th><th></th></tr></table></div>
  <hr style="margin:20px 0;border:1px solid #333">
  <h3 style="margin-top:20px">Ajustar Saldo do Cliente</h3>
  <input id="saldoNome" class="input" placeholder="Nome do Cliente">
  <input id="saldoValor" type="number" step="0.01" class="input" placeholder="Valor (use negativo para retirar)">
  <button class="btn green" id="btnAjustarSaldo">APLICAR</button>
  <div id="saldoMsg" class="msg"></div>

<h3 style="color:var(--cyan)">Gerenciar Produtos</h3>
<input id="prodNome" class="input" placeholder="Nome do Produto">
<input id="prodValor" type="number" step="0.01" class="input" placeholder="Valor (R$)">
  <input id="prodCusto" type="number" step="0.01" class="input" placeholder="Custo (R$)">
<input id="prodEstoque" type="number" class="input" placeholder="Estoque">
<button class="btn green" id="btnSalvarProduto">SALVAR PRODUTO</button>

<div id="listaProdutos" style="max-height:200px;overflow:auto;margin-top:10px"></div>

<hr style="margin:20px 0;border:1px solid #333">

<h3 style="color:var(--pink)">Desconto Personalizado</h3>
<input id="descNome" class="input" placeholder="Nome do Cliente">
<input id="descValor" type="number" min="0" max="100" class="input" placeholder="Desconto % (1 a 100)">
<button class="btn gold" id="btnAplicarDesconto">APLICAR DESCONTO</button>

  <button class="btn" style="margin-top:20px" id="btnSairAdm">Sair</button>
</div>

<div id="cliente" class="card hidden">
  <h2 style="color:var(--cyan)">Olá, <span id="nomeCli"></span>!</h2>

  <p>
    Elétrons: <b id="eletrons">0</b><br>
    Saldo: R$ <b id="saldoCli">0,00</b>
  </p>

  <hr style="margin:15px 0;border:1px solid #333">

  <button class="btn green" id="btnVender">VENDER ELÉTRONS</button>
  <button class="btn green" id="btnLoja">LOJA</button>
  <button class="btn gold" id="btnSacarCli">SACAR SALDO</button>
  
  <hr style="margin:15px 0;border:1px solid #333">

  <button class="btn" style="background:#8B00FF;color:#fff" id="btnProdutos">
MEUS PRODUTOS
</button>

  <button class="btn green" id="btnTransferir">
TRANSFERIR SALDO
</button>

  <hr style="margin:15px 0;border:1px solid #333">

  <button class="btn" id="btnTrocarSenhaCli">Trocar Minha Senha</button>
  
 <button class="btn red" id="btnSairCli">Sair</button>

</div>

<div id="venderDiv" class="card hidden"><h2>Vender Elétrons</h2><p>Você tem: <b id="temEle">0</b> elétrons</p><input id="qtdVenda" type="number" min="1" class="input" placeholder="Quantidade"><input id="precoVenda" type="number" step="0.01" min="2" class="input" placeholder="Preço por elétron (mín. 2)"><p>Total: R$ <b id="totalVenda">0,00</b></p><button class="btn green" id="btnAnunciar">ANUNCIAR</button><button class="btn" id="btnCancelarVender">Cancelar</button></div>

<div id="lojaDiv" class="card hidden"><h2 style="color:var(--green)">Loja P2P</h2><div id="listaAnuncios" style="max-height:400px;overflow:auto"></div><button class="btn" style="margin-top:15px" id="btnVoltarLoja">Voltar</button></div>

  <div id="produtosDiv" class="card hidden">
  <h2 style="color:var(--gold)">Meus Produtos Digitais</h2>
  <div id="listaMeusProdutos"></div>
  <button class="btn" style="margin-top:15px" id="btnVoltarProdutos">Voltar</button>
</div>

<div id="trocaSenhaAdm" class="card hidden"><h2 style="color:var(--gold)">Trocar Senha Admin</h2><input id="oldPassAdm" type="password" class="input" placeholder="Senha atual"><input id="newPassAdm1" type="password" class="input" placeholder="Nova"><input id="newPassAdm2" type="password" class="input" placeholder="Repetir"><button class="btn green" id="btnSalvarSenhaAdm">SALVAR</button><button class="btn" id="btnCancelarSenhaAdm">Cancelar</button><div id="msgSenhaAdm" class="msg err"></div></div>

<div id="trocaSenhaCli" class="card hidden"><h2 style="color:var(--cyan)">Trocar Sua Senha</h2><p><small>Deixe em branco para remover</small></p><input id="novaSenhaCli1" type="password" class="input" placeholder="Nova"><input id="novaSenhaCli2" type="password" class="input" placeholder="Repetir"><button class="btn green" id="btnSalvarSenhaCli">SALVAR</button><button class="btn" id="btnCancelarSenhaCli">Cancelar</button><div id="msgSenhaCli" class="msg"></div></div>

<!-- Firebase (modular) -->
<script type="module">
  console.log("SCRIPT CARREGADO - VERSÃO CORRIGIDA");
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
    collection, getDocs, addDoc, onSnapshot, query, orderBy
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyARmdv2Zet_EXfUmOXpjzuafNjqZgWi4Gg",
    authDomain: "atomic-2026.firebaseapp.com",
    projectId: "atomic-2026",
    storageBucket: "atomic-2026.firebasestorage.app",
    messagingSenderId: "466342337880",
    appId: "1:466342337880:web:ec364294a86b63cdba992d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- UTIL ----------
  window.addEventListener('error', function(e){
    console.error("ERRO GLOBAL:", e.message);
  });

  function h(s){ if(!s) return null; let x=0; for(let i=0;i<s.length;i++) x=(x*31+s.charCodeAt(i))|0; return x.toString(16); }
  
  const msg = (id, txt, err=false) => {
    const e = document.getElementById(id);
    if(e){ e.textContent = txt; e.className = 'msg' + (err ? ' err' : ''); setTimeout(()=>{ if(e) e.textContent = '' }, 5000); }
  };
  
  const volta = i => {
    document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
    const t=['main','adminLogin','painel','cliente','venderDiv','lojaDiv','trocaSenhaAdm','trocaSenhaCli','produtosDiv'];
    document.getElementById(t[i])?.classList.remove('hidden');
  };
  
  function slug(n){ return n.trim().toLowerCase().replace(/\s+/g,'-'); }

  // ---------- FIRESTORE HELPERS ----------
  const metaRef = doc(db, 'meta', 'adm');
  const clientesCol = collection(db, 'clientes');
  const anunciosCol = collection(db, 'anuncios');
  const trocasCol = collection(db, 'trocas');
  const saquesCol = collection(db, 'saques');
  const produtosCol = collection(db, 'produtos');
  const marketplaceCol = collection(db, 'marketplace');

  async function ensureAdminDoc(){
    const snap = await getDoc(metaRef);
    if(!snap.exists()){
      await setDoc(metaRef, {
        user: 'adm',
        pass: h('123'),
        saldo: 0,
        saldoInsumos: 0
      });
    }
  }

  async function setClienteObject(cli){
    const id = slug(cli.nome);
    if(!cli.produtosDigitais) cli.produtosDigitais = [];
    if(typeof cli.desconto !== "number") cli.desconto = 0;
    await setDoc(doc(db, 'clientes', id), cli);
  }

  async function getClienteByName(nome){
    if(!nome) return null;
    const id = slug(nome);
    const d = doc(db, 'clientes', id);
    const snap = await getDoc(d);
    return snap.exists() ? snap.data() : null;
  }
  
  async function deleteClienteByName(nome){
    const id = slug(nome);
    await deleteDoc(doc(db, 'clientes', id));
  }
  
  async function ajustarSaldoCliente(){
    try{
      const nome = document.getElementById('saldoNome').value.trim();
      const valor = +document.getElementById('saldoValor').value;

      if(!nome || isNaN(valor))
        return msg('saldoMsg','Preencha corretamente',true);

      const cli = await getClienteByName(nome);
      if(!cli)
        return msg('saldoMsg','Cliente não encontrado',true);

      cli.saldo = Number(((cli.saldo || 0) + valor).toFixed(2));

      if(cli.saldo < 0)
        cli.saldo = 0;

      await setClienteObject(cli);

      msg('saldoMsg','Saldo atualizado!');
    }catch(e){
      msg('saldoMsg','Erro: '+e.message,true);
    }
  }
  
  async function transferirSaldo(){
    try{
      const destino = prompt("Transferir para qual cliente?");
      if(!destino) return;

      const valor = +prompt("Valor da transferência:");
      if(!valor || valor <= 0)
        return alert("Valor inválido");

      if((user.saldo || 0) < valor)
        return alert("Saldo insuficiente");

      const cliDestino = await getClienteByName(destino);
      if(!cliDestino)
        return alert("Cliente não encontrado");

      // debita remetente
      user.saldo -= valor;

      // credita destino
      cliDestino.saldo = (cliDestino.saldo || 0) + valor;

      await setClienteObject(user);
      await setClienteObject(cliDestino);

      document.getElementById('saldoCli')
        .textContent = Number(user.saldo ||0).toFixed(2);

      alert("Transferência realizada!");

    }catch(e){
      alert("Erro: "+e.message);
    }
  }

  async function addAnuncioObj(a){
    const id = String(Date.now()) + Math.floor(Math.random()*9999);
    await setDoc(doc(db, 'anuncios', id), { ...a, id });
  }
  
  async function updateAnuncioObj(a){
    await setDoc(doc(db, 'anuncios', a.id), a);
  }
  
  async function deleteAnuncioById(id){
    await deleteDoc(doc(db, 'anuncios', id));
  }

  async function addSaqueObj(s){
    const id = String(Date.now()) + Math.floor(Math.random()*9999);
    await setDoc(doc(db, 'saques', id), s);
  }
  
  async function deleteSaqueById(id){
    await deleteDoc(doc(db, 'saques', id));
  }

  // ---------- STATE ----------
  let user = null; // objeto do cliente atual

  // ---------- DOM bindings ----------
  document.getElementById('btnEntrar').addEventListener('click', entrar);
  document.getElementById('linkAdmin').addEventListener('click', (e)=>{ e.preventDefault(); volta(1); });
  document.getElementById('btnLoginAdm').addEventListener('click', loginAdm);
  document.getElementById('btnSairAdm').addEventListener('click', ()=>volta(0));
  document.getElementById('btnSacarAdm').addEventListener('click', sacarAdm);
  document.getElementById('btnDistribuir').addEventListener('click', distribuir);
  document.getElementById('btnAddCliente').addEventListener('click', addCliente);
  document.getElementById('btnAjustarSaldo').addEventListener('click', ajustarSaldoCliente);
  document.getElementById('btnRetirar').addEventListener('click', retirar);
  document.getElementById('btnTransferir').addEventListener('click', transferirSaldo);
  document.getElementById('btnVender').addEventListener('click', vender);
  document.getElementById('btnLoja').addEventListener('click', loja);
  document.getElementById('btnAnunciar').addEventListener('click', anunciar);
  document.getElementById('btnCancelarVender').addEventListener('click', ()=>volta(3));
  document.getElementById('btnVoltarLoja').addEventListener('click', ()=>volta(3));
  document.getElementById('btnSacarCli').addEventListener('click', sacarCli);
  document.getElementById('btnTrocarSenhaCli').addEventListener('click', ()=>volta(7));
  document.getElementById('btnSalvarSenhaCli').addEventListener('click', salvarSenhaCliente);
  document.getElementById('btnSalvarSenhaAdm').addEventListener('click', salvarSenhaAdm);
  document.getElementById('btnCancelarSenhaAdm').addEventListener('click', ()=>volta(2));
  document.getElementById('btnCancelarSenhaCli').addEventListener('click', ()=>volta(3));
  document.getElementById('btnSairCli').addEventListener('click', ()=>{ user=null; volta(0); });
  document.getElementById('btnSalvarProduto').addEventListener('click', salvarProduto);
  document.getElementById('btnAplicarDesconto').addEventListener('click', aplicarDesconto);
  document.getElementById('btnProdutos').addEventListener('click', abrirProdutos);
  document.getElementById('btnVoltarProdutos').addEventListener('click', ()=>volta(3));
  document.getElementById('btnComprarInsumo').addEventListener('click', async ()=>{
    const valor = +document.getElementById('valorInsumo').value;
    if(!valor || valor <= 0) return alert("Valor inválido");
    await comprarInsumo(valor);
    document.getElementById('valorInsumo').value = '';
  });

  // Added listener to open admin password change panel (fix)
  const linkTrocar = document.getElementById('linkTrocarSenhaAdm');
  if(linkTrocar){
    linkTrocar.addEventListener('click', (e)=>{
      e.preventDefault();
      const oldI = document.getElementById('oldPassAdm');
      const n1 = document.getElementById('newPassAdm1');
      const n2 = document.getElementById('newPassAdm2');
      if(oldI) oldI.value = '';
      if(n1) n1.value = '';
      if(n2) n2.value = '';
      msg('msgSenhaAdm', '');
      volta(6);
    });
  }

  // ---------- Real-time listeners ----------
  // admin meta (user/pass/saldo)
  onSnapshot(metaRef, snap=>{
    if(!snap.exists()) return;
    const a = snap.data() || {};
    document.getElementById('saldoAdm').textContent = Number(a.saldo || 0).toFixed(2);
    document.getElementById('saldoInsumos').textContent = Number(a.saldoInsumos || 0).toFixed(2);
  });

  // clientes snapshot -> atualiza tabela do admin e atualiza UI do cliente logado
  onSnapshot(query(clientesCol, orderBy('__name__')), snapshot=>{
    const tb = document.getElementById('tabela');
    if(tb) {
      tb.innerHTML = '<tr><th>Nome</th><th>Elétrons</th><th>Saldo R$</th><th>Desc%</th><th></th></tr>';
      const clients = [];
      snapshot.forEach(d=>{
        const c = d.data();
        clients.push(c);
        const enc = encodeURIComponent(c.nome);
        tb.innerHTML += `
<tr>
<td>${c.nome}</td>
<td>${c.eletrons||0}</td>
<td>${(c.saldo||0).toFixed(2)}</td>
<td>${c.desconto||0}%</td>
<td><button class="red" data-name="${c.nome}">X</button></td>
</tr>`;
      });
      // attach delete handlers
      tb.querySelectorAll('button.red').forEach(btn=>{
        btn.onclick = async ()=> {
          const nome = btn.getAttribute('data-name');
          if(!confirm('Excluir cliente?')) return;
          await deleteClienteByName(nome);
        };
      });

      // if logged-in user, refresh its displayed info from Firestore
      if(user){
        const updated = clients.find(x=>x.nome.toLowerCase() === user.nome.toLowerCase());
        if(updated){
          user = updated;
          document.getElementById('nomeCli').textContent = user.nome;
          document.getElementById('eletrons').textContent = user.eletrons || 0;
          document.getElementById('saldoCli').textContent = (user.saldo || 0).toFixed(2);
        } else {
          // user removed
          user = null;
          volta(0);
        }
      }
    }
  });

  // anuncios snapshot -> atualiza loja
  onSnapshot(query(anunciosCol, orderBy('__name__')), snapshot=>{
    const a = [];
    snapshot.forEach(d=> a.push(d.data()));
    const lista = document.getElementById('listaAnuncios');
    if(lista){
      renderizarLoja(lista, a);
    }
  });

  // marketplace snapshot
  onSnapshot(query(marketplaceCol, orderBy('__name__')), snapshot=>{
    const lista = document.getElementById('listaAnuncios');
    if(lista && document.getElementById('lojaDiv') && !document.getElementById('lojaDiv').classList.contains('hidden')){
      // Se a loja estiver visível, re-renderiza completa
      carregarErenderizarLoja();
    }
  });

  // produtos snapshot
  onSnapshot(query(produtosCol, orderBy('__name__')), snapshot=>{
    const listaProd = document.getElementById('listaProdutos');
    if(listaProd){
      listaProd.innerHTML = '';
      snapshot.forEach(docu=>{
        const p = docu.data();
        listaProd.innerHTML += `
          <div style="background:rgba(42,42,45,.6);padding:10px;margin:6px 0;border-radius:10px">
            <b>${p.nome}</b><br>
            Venda: R$ ${Number(p.valorVenda || 0).toFixed(2)}<br>
            Custo: R$ ${Number(p.custoCompra || 0).toFixed(2)}<br>
            Estoque: ${p.estoque}
            <br>
            <button class="btn gold" style="font-size:12px;padding:6px;margin-top:5px"
              onclick="editarProduto('${p.id}')">
              EDITAR
            </button>
          </div>
        `;
      });
    }
  });

  // saques snapshot -> atualiza painel de saques
  onSnapshot(query(saquesCol, orderBy('__name__')), snapshot=>{
    const d = document.getElementById('saquesPendentes');
    if(d){
      const arr = [];
      snapshot.forEach(docu => { arr.push({ id: docu.id, ...docu.data() }); });
      d.innerHTML = arr.length ? '' : '<p style="color:#888">Nenhum saque pendente</p>';
      arr.forEach(sq=>{
        d.innerHTML += `<div style="background:rgba(50,20,20,.8);padding:12px;margin:8px 0;border-radius:10px;border:1px solid #800"><b>${sq.nome}</b> → R$${(sq.valor||0).toFixed(2)}<br><small>PIX: <b>${sq.pix}</b></small><br><small>${sq.data||''}</small><br><button class="btn red" data-id="${sq.id}" style="font-size:12px;padding:6px;margin-top:8px">PAGO</button></div>`;
      });
      d.querySelectorAll('button.red').forEach(b=>{
        b.onclick = async ()=> {
          const id = b.getAttribute('data-id');
          if(!confirm('Marcar como pago?')) return;
          await deleteSaqueById(id);
        };
      });
    }
  });

  // trocas snapshot
  onSnapshot(trocasCol, snapshot=>{
    const div = document.getElementById('listaTrocas');
    if(!div) return;
    div.innerHTML = '';
    snapshot.forEach(docu=>{
      const t = docu.data();
      div.innerHTML += `
        <div style="background:rgba(80,0,0,.6);padding:10px;margin:8px 0;border-radius:10px">
          <b>${t.cliente}</b><br>
          Produto: ${t.produto}<br>
          Endereço: ${t.endereco}<br>
          <small>${t.data}</small><br>
          <button class="btn green" style="font-size:12px;padding:6px;margin-top:6px"
            onclick="confirmarTroca('${docu.id}')">
            CONFIRMAR ENVIO
          </button>
        </div>
      `;
    });
  });

  // ---------- FUNÇÕES PRINCIPAIS ----------

  async function entrar(){
    try{
      console.log("ENTRAR FOI CLICADO");
      const n = document.getElementById('nome').value.trim();
      const p = document.getElementById('senhaCli').value;
      if(!n) return msg('msg','Digite seu nome',true);
      const c = await getClienteByName(n);
      if(!c) return msg('msg','Nome não encontrado! Compre primeiro.',true);
      if(c.pass && h(p) !== c.pass) return msg('msg','Senha incorreta!',true);
      user = c;
      document.getElementById('nomeCli').textContent = user.nome;
      document.getElementById('eletrons').textContent = user.eletrons || 0;
      document.getElementById('saldoCli').textContent = (user.saldo || 0).toFixed(2);
      volta(3);
    }catch(e){ console.error(e); msg('msg','Erro: '+e.message,true); }
  }

  async function loginAdm(){
    try{
      const u = document.getElementById('admUser').value.trim();
      const p = document.getElementById('admPass').value;
      const snap = await getDoc(metaRef);
      const a = snap.exists() ? snap.data() : null;
      if(a && u === a.user && h(p) === a.pass){ await loadPainel(); volta(2); } else { msg('admMsg','Dados incorretos',true); }
    }catch(e){ console.error(e); msg('admMsg','Erro: '+e.message,true); }
  }

  async function loadPainel(){
    const snap = await getDoc(metaRef);
    if(!snap.exists()){
      await setDoc(metaRef, { user:'adm', pass:h('123'), saldo:0, saldoInsumos:0 });
      document.getElementById('saldoAdm').textContent = '0.00';
      return;
    }
    const a = snap.data() || {};
    document.getElementById('saldoAdm').textContent = Number(a.saldo || 0).toFixed(2);
  }

  async function retirar(){
    try{
      const nome = document.getElementById('retNome').value.trim();
      const qtd = +document.getElementById('retQtd').value;
      if(!nome || !qtd) return msg('retMsg','Preencha tudo',true);
      const cli = await getClienteByName(nome);
      if(!cli) return msg('retMsg','Cliente não encontrado',true);
      if((cli.eletrons||0) < qtd) return msg('retMsg','Elétrons insuficientes',true);
      cli.eletrons = (cli.eletrons||0) - qtd;
      await setClienteObject(cli);
      await addAnuncioObj({ vendedor: 'ATOMIC', qtd: qtd, preco: 3, lucro: 0 });
      msg('retMsg', `${qtd} elétrons retirados de ${nome} e colocados na loja por R$3`, false);
    }catch(e){ console.error(e); msg('retMsg','Erro: '+e.message,true); }
  }

  async function distribuir(){
    try{
      const total = +document.getElementById('lucroTotal').value;
      if(!total || total <= 0) return alert('Valor inválido');

      const clientsSnap = await getDocs(clientesCol);
      const anunciosSnap = await getDocs(anunciosCol);

      const clientes = clientsSnap.docs.map(d=>d.data());
      const anuncios = anunciosSnap.docs.map(d=>d.data());

      const totalEle =
        clientes.reduce((s,c)=>s+(c.eletrons||0),0) +
        anuncios.reduce((s,a)=>s+(a.qtd||0),0);

      if(totalEle === 0) return alert('Sem elétrons');

      const porEle = (total * 0.75) / totalEle;
      if(!isFinite(porEle)) return alert('Erro no cálculo');

      // ===== CLIENTES =====
      for(const c of clientes){
        const walletEle = (c.eletrons||0);
        const ganho = walletEle * porEle;
        if(ganho > 0){
          c.saldo = Number(( (c.saldo||0) + ganho ).toFixed(2));
          await setClienteObject(c);
        }
      }

      // ===== ANÚNCIOS =====
      for(const a of anuncios){
        const adicional = (a.qtd||0) * porEle;
        if(adicional > 0){
          a.lucro = Number(((a.lucro||0) + adicional).toFixed(2));
          await updateAnuncioObj(a);
        }
      }

      // ===== CASA =====
      const snap = await getDoc(metaRef);
      const aadm = snap.exists() ? snap.data() : { user:'adm', pass:h('123'), saldo:0, saldoInsumos:0 };
      aadm.saldo = Number(((aadm.saldo||0) + (total*0.25)).toFixed(2));
      await setDoc(metaRef, aadm);

      msg('distMsg', `Distribuído! Casa +R$${(total*0.25).toFixed(2)}`);
      document.getElementById('lucroTotal').value = '';

    }catch(e){
      console.error(e);
      alert('Erro: '+e.message);
    }
  }

  async function cancelar(id){
    try{
      if(!confirm('Cancelar?')) return;
      const aSnap = await getDocs(anunciosCol);
      const anuncios = aSnap.docs.map(d=>d.data());
      const a = anuncios.find(x=>x.id===id);
      if(!a) return;
      const sellerName = a.vendedor;
      if(sellerName === 'ATOMIC'){
        await deleteAnuncioById(id);
        await loja();
        return;
      }
      const cli = await getClienteByName(sellerName);
      if(cli){
        cli.eletrons = (cli.eletrons || 0) + (a.qtd || 0);
        cli.saldo = (cli.saldo || 0) + (a.lucro || 0);
        cli.eletrons = Math.max(0, cli.eletrons);
        cli.saldo = Number((cli.saldo||0).toFixed(2));
        await setClienteObject(cli);
      } else {
        const newCli = { nome: sellerName, eletrons: (a.qtd||0), saldo: Number((a.lucro||0).toFixed(2)), pass: null, produtosDigitais: [], desconto: 0 };
        await setClienteObject(newCli);
      }
      await deleteAnuncioById(id);
      await loja();
    }catch(e){ console.error(e); alert('Erro: '+e.message); }
  }

  async function comprar(id){
    try{
      const aSnap = await getDocs(anunciosCol);
      const anuncios = aSnap.docs.map(d=>d.data());
      const a = anuncios.find(x=>x.id===id);
      if(!a || (user && a.vendedor === user.nome)) return;
      
      const qtd = +prompt(`Quantos (máx ${a.qtd})?`, a.qtd) || 0;
      if(qtd < 1 || qtd > a.qtd) return alert('Quantidade inválida');
      
      const total = qtd * a.preco;
      const bonus = a.qtd ? (qtd * (a.lucro || 0) / a.qtd) : 0;
      
      // VERIFICAÇÃO CRÍTICA: Saldo do comprador
      if((user.saldo || 0) < total) {
        alert(`Saldo insuficiente! Você tem R$ ${(user.saldo || 0).toFixed(2)} e precisa de R$ ${total.toFixed(2)}`);
        return;
      }

      console.log("ANTES da compra - Saldo user:", user.saldo, "Total:", total);
      
      // update buyer - CORRIGIDO: desconta o total e adiciona o bônus
      user.saldo = Number(((user.saldo || 0) - total + bonus).toFixed(2));
      user.eletrons = (user.eletrons || 0) + qtd;
      
      console.log("DEPOIS do cálculo - Saldo user:", user.saldo);
      
      await setClienteObject(user);

      if(a.vendedor === 'ATOMIC'){
        const snap = await getDoc(metaRef);
        const casa = snap.exists() ? snap.data() : { user:'adm', pass:h('123'), saldo:0, saldoInsumos:0 };
        casa.saldo = Number(((casa.saldo || 0) + total).toFixed(2));
        await setDoc(metaRef, casa);
      } else {
        const vendedor = await getClienteByName(a.vendedor);
        if(vendedor){
          vendedor.saldo = Number(((vendedor.saldo || 0) + (total * 0.9)).toFixed(2));
          await setClienteObject(vendedor);
        }
        const snap = await getDoc(metaRef);
        const casa = snap.exists() ? snap.data() : { user:'adm', pass:h('123'), saldo:0, saldoInsumos:0 };
        casa.saldo = Number(((casa.saldo || 0) + (total * 0.1)).toFixed(2));
        await setDoc(metaRef, casa);
      }

      // update anuncio
      a.qtd -= qtd;
      a.lucro = (a.lucro || 0) - bonus;
      if(a.qtd <= 0) await deleteAnuncioById(a.id); else await updateAnuncioObj(a);

      // Atualiza UI imediatamente
      document.getElementById('eletrons').textContent = user.eletrons;
      document.getElementById('saldoCli').textContent = (user.saldo||0).toFixed(2);
      
      alert(`Comprado! +${qtd} elétrons\n+Bônus R$${bonus.toFixed(2)}`);
      await loja();
    }catch(e){ 
      console.error('Erro compra:', e); 
      alert('Erro compra: '+e.message); 
    }
  }

  async function carregarErenderizarLoja() {
    const lista = document.getElementById('listaAnuncios');
    if (!lista) return;
    
    lista.innerHTML = '';
    
    // Buscar todos os dados necessários
    const [produtosSnap, marketSnap, anunciosSnap] = await Promise.all([
      getDocs(produtosCol),
      getDocs(marketplaceCol),
      getDocs(anunciosCol)
    ]);
    
    // Produtos oficiais
    produtosSnap.forEach(docu => {
      const p = docu.data();
      const div = document.createElement('div');
      div.style = "background:rgba(0,100,0,.3);padding:14px;margin:8px 0;border-radius:12px;border:1px solid var(--green)";
      
      let valorExibido = p.valorVenda;
      if (user && user.desconto && user.desconto > 0) {
        valorExibido = p.valorVenda * (1 - user.desconto/100);
      }
      
      div.innerHTML = `
        <b>${p.nome}</b><br>
        R$ ${Number(p.valorVenda || 0).toFixed(2)}
        ${user && user.desconto ? `<br><span style="color:var(--gold)">Com desconto: R$ ${valorExibido.toFixed(2)}</span>` : ''}
        | Estoque: ${p.estoque}
      `;
      
      const btn = document.createElement('button');
      btn.className = "btn gold";
      btn.style.marginTop = "8px";
      btn.textContent = "Comprar da Loja";
      btn.onclick = () => comprarProdutoLoja(p.id);
      div.appendChild(btn);
      lista.appendChild(div);
    });
    
    // Marketplace
    marketSnap.forEach(docu => {
      const m = docu.data();
      const div = document.createElement('div');
      div.style = "background:rgba(100,0,100,.3);padding:14px;margin:8px 0;border-radius:12px;border:1px solid var(--pink)";
      div.innerHTML = `
        <b>${m.nome}</b><br>
        Vendedor: ${m.vendedor}<br>
        R$ ${Number(m.valor || 0).toFixed(2)}
      `;
      
      const btn = document.createElement('button');
      if(user && user.nome === m.vendedor){
        btn.className = "btn red";
        btn.textContent = "Cancelar";
        btn.onclick = ()=> cancelarMarketplace(docu.id);
      } else {
        btn.className = "btn green";
        btn.textContent = "Comprar";
        btn.onclick = ()=> comprarMarketplace(docu.id);
      }
      div.appendChild(btn);
      lista.appendChild(div);
    });
    
    // Anúncios P2P
    anunciosSnap.forEach(docu => {
      const a = docu.data();
      const div = document.createElement('div');
      div.style = "background:rgba(42,42,45,.6);padding:14px;margin:8px 0;border-radius:12px;border:1px solid var(--gold)";
      div.innerHTML = `
        <b>${a.vendedor}</b><br>
        ${a.qtd} elétrons<br>
        R$ ${Number(a.preco || 0).toFixed(2)} cada
      `;
      
      const btn = document.createElement('button');
      if(user && user.nome === a.vendedor){
        btn.className = "btn red";
        btn.textContent = "Cancelar";
        btn.onclick = ()=> cancelar(a.id);
      } else {
        btn.className = "btn green";
        btn.textContent = "Comprar";
        btn.onclick = ()=> comprar(a.id);
      }
      div.appendChild(btn);
      lista.appendChild(div);
    });
  }

  async function loja(){
    await carregarErenderizarLoja();
    volta(5);
  }

  async function anunciar(){
    try{
      const q = +document.getElementById('qtdVenda').value;
      const p = +document.getElementById('precoVenda').value;
      if(q < 1 || q > (user.eletrons || 0) || p < 2) return alert('Erro');
      user.eletrons -= q;
      await setClienteObject(user);
      await addAnuncioObj({ vendedor: user.nome, qtd: q, preco: p, lucro: 0 });
      alert('Anunciado!');
      volta(3);
    }catch(e){ console.error(e); alert('Erro anunciar: '+e.message); }
  }

  async function comprarInsumo(valor){
    const snap = await getDoc(metaRef);
    const admin = snap.data();
    if((admin.saldoInsumos || 0) < valor)
      return alert("Saldo de insumos insuficiente");
    admin.saldoInsumos -= valor;
    await setDoc(metaRef, admin);
    alert("Insumo comprado com saldo de reposição");
  }

  function vender(){
    document.getElementById('temEle').textContent = user.eletrons||0;
    document.getElementById('qtdVenda').max = user.eletrons||0;
    const calc = () => document.getElementById('totalVenda').textContent = ((+document.getElementById('qtdVenda').value||0)*(+document.getElementById('precoVenda').value||0)).toFixed(2);
    document.getElementById('qtdVenda').oninput = calc;
    document.getElementById('precoVenda').oninput = calc;
    volta(4);
  }

  async function sacarCli(){
    try{
      if((user.saldo || 0) <= 0) return alert('Sem saldo');
      const pix = prompt(`Sacando R$${(user.saldo||0).toFixed(2)}\nChave Pix:`);
      if(pix && pix.trim()){
        await addSaqueObj({ nome: user.nome, valor: user.saldo, pix: pix.trim(), data: new Date().toLocaleString('pt-BR') });
        user.saldo = 0;
        await setClienteObject(user);
        document.getElementById('saldoCli').textContent = '0.00';
        alert('Saque solicitado!');
        volta(3);
      }
    }catch(e){ console.error(e); alert('Erro saque: '+e.message); }
  }
  
  async function distribuirAutomatico(valor){
    if(valor <= 0) return;
    const clientesSnap = await getDocs(clientesCol);
    const clientes = clientesSnap.docs.map(d=>d.data());
    const totalEle = clientes.reduce((s,c)=>s+(c.eletrons||0),0);
    if(totalEle === 0) return;
    const porEletron = valor / totalEle;
    for(const c of clientes){
      const ganho = (c.eletrons||0) * porEletron;
      if(ganho > 0){
        c.saldo = Number(((c.saldo||0) + ganho).toFixed(2));
        await setClienteObject(c);
      }
    }
  }

  async function addCliente(){
    try{
      const n = document.getElementById('newNome').value.trim();
      const a = +document.getElementById('newAtom').value;
      if(!n || !a) return alert('Preencha');
      const exists = await getClienteByName(n);
      if(exists) return alert('Já existe');
      const cli = {nome: n, eletrons: a * 100, saldo: 0, pass: null, produtosDigitais: [], desconto: 0};
      await setClienteObject(cli);
      document.getElementById('newNome').value = '';
      document.getElementById('newAtom').value = '';
    }catch(e){ console.error(e); alert('Erro addCliente: '+e.message); }
  }

  async function sacarAdm(){
    try{
      const snap = await getDoc(metaRef);
      const a = snap.exists() ? snap.data() : null;
      if(!a || (a.saldo || 0) <= 0) return alert('Sem saldo');
      if(confirm(`Sacar R$${(a.saldo||0).toFixed(2)}?`)){
        a.saldo = 0;
        await setDoc(metaRef, a);
        alert('Sacado!');
      }
    }catch(e){ console.error(e); alert('Erro sacarAdm: '+e.message); }
  }

  async function salvarSenhaAdm(){
    try{
      const o = document.getElementById('oldPassAdm').value;
      const n1 = document.getElementById('newPassAdm1').value;
      const n2 = document.getElementById('newPassAdm2').value;
      const snap = await getDoc(metaRef);
      const a = snap.exists() ? snap.data() : null;
      if(!a) return msg('msgSenhaAdm','Erro admin',true);
      if(h(o) !== a.pass) return msg('msgSenhaAdm','Senha atual errada',true);
      if(n1 !== n2) return msg('msgSenhaAdm','Senhas não coincidem',true);
      if(n1 && n1.length < 3) return msg('msgSenhaAdm','Mínimo 3 caracteres',true);
      a.pass = h(n1);
      await setDoc(metaRef, a);
      msg('msgSenhaAdm','Senha alterada!');
      setTimeout(()=>volta(2),2000);
    }catch(e){ console.error(e); msg('msgSenhaAdm','Erro: '+e.message,true); }
  }

  async function salvarSenhaCliente(){
    try{
      const s1 = document.getElementById('novaSenhaCli1').value;
      const s2 = document.getElementById('novaSenhaCli2').value;
      if(s1 !== s2) return msg('msgSenhaCli','Senhas não coincidem',true);
      if(s1 && s1.length < 3) return msg('msgSenhaCli','Mínimo 3 caracteres',true);
      user.pass = s1 ? h(s1) : null;
      await setClienteObject(user);
      msg('msgSenhaCli', s1 ? 'Senha alterada!' : 'Senha removida!');
      setTimeout(()=>volta(3),2000);
    }catch(e){ console.error(e); msg('msgSenhaCli','Erro: '+e.message,true); }
  }

  // ================= PRODUTOS =================

  async function salvarProduto(){
    try{
      const nome = document.getElementById('prodNome').value.trim();
      const valor = +document.getElementById('prodValor').value;
      const custo = +document.getElementById('prodCusto').value;
      const estoque = +document.getElementById('prodEstoque').value;

      if(!nome || !valor || !custo || estoque < 0)
        return alert('Preencha corretamente');

      if(custo > valor)
        return alert('Custo não pode ser maior que valor de venda');

      const id = slug(nome);

      await setDoc(doc(produtosCol, id), {
        id,
        nome,
        valorVenda: valor,
        custoCompra: custo,
        estoque,
        atualizadoEm: new Date().toISOString()
      });

      document.getElementById('prodNome').value = '';
      document.getElementById('prodValor').value = '';
      document.getElementById('prodCusto').value = '';
      document.getElementById('prodEstoque').value = '';

      alert('Produto salvo!');
    }catch(e){
      alert('Erro: '+e.message);
    }
  }

  // ================= DESCONTO =================

  async function aplicarDesconto(){
    try{
      const nome = document.getElementById('descNome').value.trim();
      const valor = +document.getElementById('descValor').value;

      if(!nome || valor < 0 || valor > 100)
        return alert('Informe entre 0 e 100%');

      const cli = await getClienteByName(nome);
      if(!cli) return alert('Cliente não encontrado');

      cli.desconto = valor;
      await setClienteObject(cli);

      alert(`Desconto de ${valor}% aplicado para ${nome}`);
    }catch(e){
      alert('Erro: '+e.message);
    }
  }

  window.editarProduto = async function(id){
    const ref = doc(produtosCol, id);
    const snap = await getDoc(ref);
    if(!snap.exists()) return alert("Produto não encontrado");
    const p = snap.data();
    document.getElementById('prodNome').value = p.nome;
    document.getElementById('prodValor').value = p.valorVenda || 0;
    document.getElementById('prodCusto').value = p.custoCompra || 0;
    document.getElementById('prodEstoque').value = p.estoque || 0;
  };

  // ================= COMPRA LOJA OFICIAL =================
window.comprarProdutoLoja = async function(prodId){
  try{
    const ref = doc(produtosCol, prodId);
    const snap = await getDoc(ref);
    if(!snap.exists()) return alert('Produto não encontrado');

    const produto = snap.data();

    if(produto.estoque <= 0) return alert('Sem estoque');

    let valorFinal = produto.valorVenda;

    // aplicar desconto se existir
    if(user.desconto && user.desconto > 0){
      valorFinal = valorFinal - (valorFinal * (user.desconto/100));
    }

    if((user.saldo||0) < valorFinal)
      return alert('Saldo insuficiente');

    if(!confirm(`Comprar ${produto.nome} por R$${valorFinal.toFixed(2)}?`))
      return;

    // BUSCAR O CLIENTE ATUALIZADO DO FIRESTORE ANTES DE MODIFICAR
    const clienteAtualizado = await getClienteByName(user.nome);
    if (!clienteAtualizado) return alert('Erro ao buscar cliente');

    // debitar saldo do cliente atualizado
    clienteAtualizado.saldo = Number((clienteAtualizado.saldo || 0) - valorFinal);
    
    // diminuir estoque
    produto.estoque -= 1;
      
    // ===== DIVISÃO FINANCEIRA =====
    const custo = produto.custoCompra || 0;
    const lucro = valorFinal - custo;

    const snapAdm = await getDoc(metaRef);
    const admin = snapAdm.data();

    // custo vai para saldo de reposição
    admin.saldoInsumos = Number((admin.saldoInsumos || 0) + custo);

    // lucro vai para saldo principal
    admin.saldo = Number((admin.saldo || 0) + lucro);

    // distribuir 2% automaticamente
    const valorDistribuir = valorFinal * 0.02;
    await distribuirAutomatico(valorDistribuir);

    // criar produto digital
    const digital = {
      id: Date.now().toString(),
      nome: produto.nome,
      valorPago: valorFinal,
      origem: "loja"
    };

    clienteAtualizado.produtosDigitais.push(digital);

    // SALVAR TUDO NO FIRESTORE
    await setClienteObject(clienteAtualizado);
    await setDoc(ref, produto);
    await setDoc(metaRef, admin);

    // ATUALIZAR O OBJETO USER LOCAL
    user = clienteAtualizado;

    // ATUALIZAR A INTERFACE
    document.getElementById('saldoCli').textContent = Number(user.saldo ||0).toFixed(2);
    document.getElementById('eletrons').textContent = user.eletrons || 0;

    alert('Produto adquirido!');
    abrirProdutos();

  }catch(e){
    alert('Erro: '+e.message);
  }
}
  function abrirProdutos(){
    const div = document.getElementById('listaMeusProdutos');
    div.innerHTML = '';

    if(!user.produtosDigitais || user.produtosDigitais.length === 0){
      div.innerHTML = '<p>Nenhum produto digital.</p>';
    }else{
      user.produtosDigitais.forEach(p=>{
        div.innerHTML += `
          <div style="background:rgba(42,42,45,.6);padding:12px;margin:8px 0;border-radius:10px">
            <b>${p.nome}</b><br>
            Pago: R$ ${Number(p.valorPago ||0).toFixed(2)}<br>
            <button class="btn green" style="font-size:12px;padding:6px;margin-top:6px"
              onclick="revenderEmpresa('${p.id}')">
              Revender p/ Empresa (-30%)
            </button>
            <button class="btn gold" style="font-size:12px;padding:6px;margin-top:6px"
              onclick="trocarFisico('${p.id}')">
              Trocar por Produto Físico
            </button>
            <button class="btn" style="background:#8B00FF;color:#fff;font-size:12px;padding:6px;margin-top:6px"
              onclick="colocarMarketplace('${p.id}')">
              Vender para Clientes
            </button>
          </div>
        `;
      });
    }
    volta(8);
  }

  window.revenderEmpresa = async function(prodId){
  const index = user.produtosDigitais.findIndex(p=>p.id===prodId);
  if(index === -1) return;

  const p = user.produtosDigitais[index];

  const valorRetorno = p.valorPago * 0.7;

  if(!confirm(`Receber R$${Number(valorRetorno ||0).toFixed(2)}?`))
    return;

  // BUSCAR CLIENTE ATUALIZADO
  const clienteAtualizado = await getClienteByName(user.nome);
  if (!clienteAtualizado) return alert('Erro ao buscar cliente');

  // ENCONTRAR O PRODUTO NO CLIENTE ATUALIZADO
  const produtoIndex = clienteAtualizado.produtosDigitais.findIndex(p => p.id === prodId);
  if (produtoIndex === -1) return alert('Produto não encontrado');
  
  const produto = clienteAtualizado.produtosDigitais[produtoIndex];

  // ===== DEVOLVER AO ESTOQUE =====
  // Buscar o produto na coleção de produtos pelo nome
  const produtosSnap = await getDocs(produtosCol);
  let produtoEstoque = null;
  let produtoRef = null;

  for (const doc of produtosSnap.docs) {
    const prod = doc.data();
    if (prod.nome === produto.nome) {
      produtoEstoque = prod;
      produtoRef = doc.ref;
      break;
    }
  }

  if (produtoEstoque && produtoRef) {
    // Aumentar o estoque
    produtoEstoque.estoque = (produtoEstoque.estoque || 0) + 1;
    await setDoc(produtoRef, produtoEstoque);
  } else {
    // Se não encontrou, criar um novo produto no estoque
    const novoProduto = {
      id: slug(produto.nome) + '-' + Date.now(),
      nome: produto.nome,
      valorVenda: produto.valorPago, // Usar o valor original como referência
      custoCompra: produto.valorPago * 0.6, // Aproximadamente 60% do valor
      estoque: 1,
      atualizadoEm: new Date().toISOString()
    };
    await setDoc(doc(produtosCol, novoProduto.id), novoProduto);
  }

  // ATUALIZAR SALDO DO CLIENTE
  clienteAtualizado.saldo = Number((clienteAtualizado.saldo || 0) + valorRetorno);
  
  // REMOVER PRODUTO DA LISTA DO CLIENTE
  clienteAtualizado.produtosDigitais.splice(produtoIndex, 1);

  // SALVAR CLIENTE ATUALIZADO
  await setClienteObject(clienteAtualizado);

  // ATUALIZAR OBJETO USER LOCAL
  user = clienteAtualizado;

  // ATUALIZAR INTERFACE
  document.getElementById('saldoCli').textContent = Number(user.saldo ||0).toFixed(2);

  alert('Revenda concluída! Produto devolvido ao estoque.');
  abrirProdutos();
};

  window.trocarFisico = async function(prodId){
    try{
      const endereco = prompt("Digite seu endereço completo:");
      if(!endereco) return;
      const index = user.produtosDigitais.findIndex(p=>p.id===prodId);
      if(index === -1) return;
      const produto = user.produtosDigitais[index];
      await addDoc(trocasCol, {
        cliente: user.nome,
        produto: produto.nome,
        endereco: endereco,
        data: new Date().toLocaleString('pt-BR'),
        status: "pendente"
      });
      user.produtosDigitais.splice(index,1);
      await setClienteObject(user);
      alert("Solicitação enviada! Aguarde confirmação.");
      abrirProdutos();
    }catch(e){
      alert("Erro: "+e.message);
    }
  };
 
  window.confirmarTroca = async function(id){
    await deleteDoc(doc(trocasCol, id));
    alert("Troca confirmada!");
  };

  window.colocarMarketplace = async function(prodId){
    const index = user.produtosDigitais.findIndex(p=>p.id===prodId);
    if(index === -1) return;
    const novoValor = +prompt("Defina o valor de venda:");
    if(!novoValor || novoValor <= 0) return alert("Valor inválido");
    const produto = user.produtosDigitais[index];
    await addDoc(marketplaceCol, {
      produtoId: produto.id,
      nome: produto.nome,
      valor: novoValor,
      vendedor: user.nome,
      criadoEm: new Date().toISOString()
    });
    user.produtosDigitais.splice(index,1);
    await setClienteObject(user);
    alert("Produto publicado no marketplace!");
    abrirProdutos();
  };

  window.comprarMarketplace = async function(docId){
    const ref = doc(marketplaceCol, docId);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    const m = snap.data();
    if(user.nome === m.vendedor) return;
    
    // VERIFICAÇÃO CRÍTICA
    if((user.saldo||0) < m.valor) {
      alert(`Saldo insuficiente! Você tem R$ ${(user.saldo || 0).toFixed(2)} e precisa de R$ ${m.valor.toFixed(2)}`);
      return;
    }

    if(!confirm(`Comprar por R$ ${Number(m.valor || 0).toFixed(2)}?`)) return;

    // debitar comprador - CORRIGIDO
    user.saldo = Number(((user.saldo || 0) - m.valor).toFixed(2));
    
    user.produtosDigitais.push({
      id: Date.now().toString(),
      nome: m.nome,
      valorPago: m.valor,
      origem: "cliente"
    });

    await setClienteObject(user);

    // pagar vendedor
    const vendedor = await getClienteByName(m.vendedor);
    if(vendedor){
      vendedor.saldo = Number(((vendedor.saldo || 0) + m.valor).toFixed(2));
      await setClienteObject(vendedor);
    }

    await deleteDoc(ref);

    document.getElementById('saldoCli').textContent = Number(user.saldo ||0).toFixed(2);
    
    alert("Compra realizada!");
    loja();
  };

  window.cancelarMarketplace = async function(docId){
    const ref = doc(marketplaceCol, docId);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    const m = snap.data();
    if(m.vendedor !== user.nome) return;
    user.produtosDigitais.push({
      id: m.produtoId,
      nome: m.nome,
      valorPago: m.valor,
      origem: "retorno"
    });
    await setClienteObject(user);
    await deleteDoc(ref);
    alert("Venda cancelada!");
    loja();
  };

  // ---------- init ----------
  (async function init(){
    try{
      await ensureAdminDoc();
      const produtosSnap = await getDocs(produtosCol);
      if(produtosSnap.empty){
        const produtoInicial = {
          id: "pacote-gel",
          nome: "Pacote de Gel",
          valorVenda: 10.00,
          custoCompra: 6.00,
          estoque: 100
        };
        await setDoc(doc(produtosCol, produtoInicial.id), produtoInicial);
      }
      const snap = await getDocs(anunciosCol);
      if(snap.empty){
        await addAnuncioObj({ vendedor: 'ATOMIC', qtd: 1000, preco: 3, lucro: 0 });
      }
    }catch(e){
      console.error('init err', e);
      msg('msg','Erro init: '+(e.message||e), true);
    }
  })();

</script>
<footer style="
  position:fixed;
  bottom:10px;
  right:60px;
  font-size:12px;
  opacity:0.5;
  letter-spacing:1px;
">Desenvolvido por Felipe Galdino Mendes
</footer>

</body>
  </html>
