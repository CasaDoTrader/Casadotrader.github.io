<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Casa do Trader</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- CSS Styles -->
    <style>
        /* Root Variables */
        :root {
            --primary: #c9a227;
            --secondary: #8b5e34;
            --text: #2d3436;
            --panel-bg: linear-gradient(135deg, #f8f9fa, #e8ecef);
            --shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
        }

        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: Roboto, sans-serif;
            background: linear-gradient(135deg, #1c2526, #4a6fa5);
            color: #fff;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
        }

        /* Container */
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            max-width: 550px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary);
        }

        /* Typography */
        h1 {
            font-size: 1.8em;
            color: var(--primary);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        p {
            font-size: 0.95em;
            color: var(--text);
            margin-bottom: 10px;
        }

        .highlight {
            color: var(--secondary);
            font-weight: 700;
        }

        /* Info Box */
        .info-box {
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: var(--shadow);
            cursor: pointer;
            border: 1px solid var(--primary);
        }

        .info-box p {
            color: var(--text);
            font-size: 0.85em;
        }

        /* Form Styling */
        .form-group {
            margin: 8px 0;
        }

        .form-group label {
            display: block;
            color: var(--text);
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 7px;
            border: 1px solid var(--primary);
            border-radius: 5px;
            font-size: 0.85em;
            background: #f8f9fa;
        }

        /* Button Styling */
        .btn {
            background: linear-gradient(var(--primary), var(--secondary));
            color: #fff;
            padding: 7px 15px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin: 5px 0;
        }

        .btn:hover {
            background: linear-gradient(var(--secondary), var(--primary));
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--primary);
        }

        /* Panel Styling */
        .panel {
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--primary);
        }

        h2 {
            color: var(--text);
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th, td {
            border: 1px solid var(--primary);
            padding: 7px;
            color: var(--text);
            font-size: 0.85em;
        }

        th {
            background: var(--panel-bg);
        }

        td {
            background: #fff;
        }

        .total-paid {
            color: var(--secondary);
            font-weight: 700;
            font-size: 0.9em;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
        }

        /* Form Row */
        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .form-row input {
            flex: 1;
            min-width: 100px;
        }

        .form-row #clientManage {
            min-width: 150px;
        }

        /* Client Panel */
        .client-panel {
            display: none;
        }

        /* NEW: Withdrawal Request Styling */
        .withdrawal-request {
            margin: 10px 0;
        }

        .withdrawal-request table td button {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <h1>Casa do Trader</h1>
        <p>Maximize seus ganhos conosco! Alcance até <span class="highlight">R$5,00 diários</span> por meio de investimentos estratégicos, com um limite máximo de perda de <strong>R$3,00 por dia</strong>.</p>
        
        <!-- Pix Key Section -->
        <section class="info-box" onclick="copyToClipboard('cec912eb-c181-40e3-accd-381cdd21ae33', 'Chave Pix copiada!')">
            <p><strong>Chave Pix:</strong> cec912eb-c181-40e3-accd-381cdd21ae33</p>
        </section>
        
        <!-- WhatsApp Section -->
        <section class="info-box" onclick="copyToClipboard('+557798175899', 'Número do WhatsApp copiado!')">
            <p>Envie o comprovante para: <strong>+55 77 9817-5899</strong></p>
        </section>
        
        <!-- Client Table -->
        <section class="panel">
            <h2>Clientes</h2>
            <table>
                <thead>
                    <tr><th>Nome</th><th>Saldo (R$)</th></tr>
                </thead>
                <tbody id="clientTable"></tbody>
            </table>
            <p class="total-paid">Total Sacado: R$<span id="totalPaid">0.00</span></p>
        </section>
        
        <!-- Client Login Section -->
        <section class="panel">
            <h2>Acesso Cliente</h2>
            <div class="form-group">
                <label for="clientLoginName">Nome:</label>
                <input type="text" id="clientLoginName" placeholder="Seu nome">
            </div>
            <div class="form-group">
                <label for="clientLoginPassword">Senha:</label>
                <input type="password" id="clientLoginPassword" placeholder="Sua senha">
            </div>
            <button class="btn" onclick="loginClient()">Entrar</button>
        </section>
        
        <!-- Client Panel -->
        <section class="client-panel" id="clientPanel">
            <h2>Seu Painel, <span id="clientNameDisplay"></span></h2>
            <div class="form-group">
                <p><strong>Saldo:</strong> R$<span id="clientBalance">0.00</span></p>
                <p><strong>Total Sacado:</strong> R$<span id="clientWithdrawn">0.00</span></p>
            </div>
            <!-- NEW: Withdrawal Request Form -->
            <div class="form-group withdrawal-request">
                <h2>Solicitar Saque</h2>
                <div class="form-row">
                    <input type="number" id="withdrawalAmount" step="0.01" min="0" placeholder="Valor (R$)">
                    <input type="text" id="withdrawalPixKey" placeholder="Chave Pix">
                    <button class="btn" onclick="requestWithdrawal()">Solicitar Saque</button>
                </div>
            </div>
            <button class="btn" onclick="changeClientPassword()">Mudar Senha</button>
            <h2>Seu Extrato</h2>
            <table>
                <thead>
                    <tr><th>Tipo</th><th>Valor (R$)</th><th>Origem</th><th>Data/Hora</th></tr>
                </thead>
                <tbody id="clientTransactionTable"></tbody>
            </table>
            <button class="btn" onclick="logoutClient()">Sair</button>
        </section>
        
        <!-- Admin Access Button -->
        <button class="btn" onclick="showAdmin()">Acesso Admin</button>
        
        <!-- Admin Panel -->
        <section class="admin-panel" id="adminPanel">
            <h2>Painel Administrativo</h2>
            <div class="form-group">
                <label for="adminPassword">Senha:</label>
                <input type="password" id="adminPassword">
                <button class="btn" onclick="loginAdmin()">Entrar</button>
            </div>
            <div id="adminControls" style="display:none">
                <button class="btn" onclick="changeAdminPassword()">Mudar Senha Admin</button>
                <!-- NEW: Pending Withdrawal Requests -->
                <div class="form-group withdrawal-request">
                    <h2>Solicitações de Saque Pendentes</h2>
                    <table>
                        <thead>
                            <tr><th>Cliente</th><th>Valor (R$)</th><th>Chave Pix</th><th>Data/Hora</th><th>Ações</th></tr>
                        </thead>
                        <tbody id="pendingWithdrawalsTable"></tbody>
                    </table>
                </div>
                <div class="form-group">
                    <label>Gerenciar Cliente:</label>
                    <div class="form-row">
                        <input type="text" id="clientManage" placeholder="Nome do cliente">
                        <select id="clientAction">
                            <option value="add">Adicionar</option>
                            <option value="delete">Excluir</option>
                        </select>
                        <button class="btn" onclick="manageClient()">Executar</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Operações:</label>
                    <div class="form-row">
                        <input type="number" id="hits" min="0" placeholder="Acertos">
                        <input type="number" id="misses" min="0" placeholder="Erros">
                        <button class="btn" onclick="updateBalances()">Registrar</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Transações:</label>
                    <div class="form-row">
                        <input type="text" id="clientName" placeholder="Nome do cliente">
                        <input type="number" id="credit" step="0.01" min="0" placeholder="Crédito (R$)">
                        <button class="btn" onclick="creditBalance()">Enviar</button>
                    </div>
                    <div class="form-row">
                        <input type="text" id="clientNameWithdraw" placeholder="Nome do cliente">
                        <input type="number" id="withdraw" step="0.01" min="0" placeholder="Saque (R$)">
                        <button class="btn" onclick="withdrawBalance()">Sacar</button>
                    </div>
                </div>
                
                <h2>Extrato</h2>
                <table>
                    <thead>
                        <tr><th>Tipo</th><th>Cliente</th><th>Valor (R$)</th><th>Origem</th><th>Data/Hora</th></tr>
                    </thead>
                    <tbody id="transactionTable"></tbody>
                </table>
                <p class="total-paid">Total Sacado: R$<span id="adminTotalPaid">0.00</span></p>
            </div>
        </section>
    </div>
    
    <!-- JavaScript Logic -->
    <script>
        // Global Data
        let clients, transactions, lastResetDate, adminPassword, pendingWithdrawals;
        try {
            clients = JSON.parse(localStorage.getItem("clients")) || {};
            Object.keys(clients).forEach(name => {
                if (!clients[name].password) {
                    clients[name].password = name;
                }
            });
            transactions = JSON.parse(localStorage.getItem("transactions")) || [];
            lastResetDate = localStorage.getItem("lastResetDate") || new Date().toISOString().split("T")[0];
            adminPassword = localStorage.getItem("adminPassword") || "887789";
            pendingWithdrawals = JSON.parse(localStorage.getItem("pendingWithdrawals")) || [];
        } catch (e) {
            clients = {};
            transactions = [];
            lastResetDate = new Date().toISOString().split("T")[0];
            adminPassword = "887789";
            pendingWithdrawals = [];
        }

        let currentClient = null;

        // DOM Elements
        const DOM = {
            clientTable: document.getElementById("clientTable"),
            transactionTable: document.getElementById("transactionTable"),
            totalPaid: document.getElementById("totalPaid"),
            adminTotalPaid: document.getElementById("adminTotalPaid"),
            adminPanel: document.getElementById("adminPanel"),
            adminControls: document.getElementById("adminControls"),
            adminPassword: document.getElementById("adminPassword"),
            clientManage: document.getElementById("clientManage"),
            clientAction: document.getElementById("clientAction"),
            hits: document.getElementById("hits"),
            misses: document.getElementById("misses"),
            clientName: document.getElementById("clientName"),
            clientNameWithdraw: document.getElementById("clientNameWithdraw"),
            credit: document.getElementById("credit"),
            withdraw: document.getElementById("withdraw"),
            clientLoginName: document.getElementById("clientLoginName"),
            clientLoginPassword: document.getElementById("clientLoginPassword"),
            clientPanel: document.getElementById("clientPanel"),
            clientNameDisplay: document.getElementById("clientNameDisplay"),
            clientBalance: document.getElementById("clientBalance"),
            clientWithdrawn: document.getElementById("clientWithdrawn"),
            clientTransactionTable: document.getElementById("clientTransactionTable"),
            // NEW: Withdrawal Request Elements
            withdrawalAmount: document.getElementById("withdrawalAmount"),
            withdrawalPixKey: document.getElementById("withdrawalPixKey"),
            pendingWithdrawalsTable: document.getElementById("pendingWithdrawalsTable")
        };

        // Data Management
        function saveData() {
            try {
                localStorage.setItem("clients", JSON.stringify(clients));
                localStorage.setItem("transactions", JSON.stringify(transactions));
                localStorage.setItem("lastResetDate", lastResetDate);
                localStorage.setItem("adminPassword", adminPassword);
                localStorage.setItem("pendingWithdrawals", JSON.stringify(pendingWithdrawals));
            } catch (e) {
                console.error("Error saving data:", e);
                alert("Erro ao salvar dados.");
            }
        }

        function getToday() {
            return new Date().toISOString().split("T")[0];
        }

        function formatDateTime() {
            const d = new Date();
            return `${d.getDate().toString().padStart(2, "0")}/${(d.getMonth() + 1).toString().padStart(2, "0")}/${d.getFullYear()} ${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}:${d.getSeconds().toString().padStart(2, "0")}`;
        }

        function copyToClipboard(text, message) {
            navigator.clipboard.writeText(text)
                .then(() => alert(message))
                .catch(() => alert("Erro ao copiar."));
        }

        function validateInput(value, message) {
            if (!value || value <= 0) {
                alert(message);
                return false;
            }
            return true;
        }

        function resetDailyData() {
            const today = getToday();
            Object.values(clients).forEach(c => {
                if (c.lastDate !== today) {
                    c.dailyLoss = 0;
                    c.dailyOps = 0;
                    c.lastDate = today;
                }
            });
        }

        function checkAndResetTransactions() {
            const today = getToday();
            if (today !== lastResetDate) {
                transactions = [];
                lastResetDate = today;
                saveData();
            }
        }

        function addTransaction(type, client, value, source) {
            transactions.push({ type, client, value, source, timestamp: formatDateTime() });
        }

        // NEW: Request Withdrawal
        function requestWithdrawal() {
            const amount = parseFloat(DOM.withdrawalAmount.value);
            const pixKey = DOM.withdrawalPixKey.value.trim();
            if (!currentClient) {
                alert("Erro: Nenhum cliente logado.");
                return;
            }
            if (!validateInput(amount, "Valor inválido.") || !pixKey) {
                alert("Insira um valor válido e uma chave Pix.");
                return;
            }
            if (amount > clients[currentClient].balance) {
                alert("Saldo insuficiente.");
                return;
            }
            pendingWithdrawals.push({
                client: currentClient,
                amount: amount,
                pixKey: pixKey,
                timestamp: formatDateTime()
            });
            saveData();
            alert(`Saque de R$${amount.toFixed(2)} solicitado. Aguarde a confirmação do administrador.`);
            DOM.withdrawalAmount.value = "";
            DOM.withdrawalPixKey.value = "";
            updatePendingWithdrawalsTable();
        }

        // NEW: Update Pending Withdrawals Table
        function updatePendingWithdrawalsTable() {
            DOM.pendingWithdrawalsTable.innerHTML = pendingWithdrawals.map((req, index) => `
                <tr>
                    <td>${req.client}</td>
                    <td>${req.amount.toFixed(2)}</td>
                    <td>${req.pixKey}</td>
                    <td>${req.timestamp}</td>
                    <td>
                        <button class="btn" onclick="copyToClipboard('${req.pixKey}', 'Chave Pix copiada!')">Copiar Pix</button>
                        <button class="btn" onclick="confirmWithdrawal(${index})">Confirmar</button>
                    </td>
                </tr>
            `).join("");
        }

        // NEW: Confirm Withdrawal
        function confirmWithdrawal(index) {
            const req = pendingWithdrawals[index];
            if (!req || !clients[req.client]) {
                alert("Erro: Solicitação ou cliente inválido.");
                return;
            }
            if (req.amount > clients[req.client].balance) {
                alert("Saldo insuficiente para confirmar o saque.");
                return;
            }
            clients[req.client].balance -= req.amount;
            clients[req.client].withdrawn += req.amount;
            addTransaction("Saque", req.client, -req.amount, "Admin (Pix)");
            pendingWithdrawals.splice(index, 1);
            saveData();
            updateTable();
            updatePendingWithdrawalsTable();
            alert(`Saque de R$${req.amount.toFixed(2)} confirmado para ${req.client}.`);
        }

        function changeAdminPassword() {
            const current = prompt("Digite a senha atual:");
            if (current !== adminPassword) {
                alert("Senha atual incorreta.");
                return;
            }
            const newPassword = prompt("Digite a nova senha:");
            if (!newPassword || newPassword.trim() === "") {
                alert("A nova senha não pode ser vazia.");
                return;
            }
            const confirmPassword = prompt("Confirme a nova senha:");
            if (newPassword !== confirmPassword) {
                alert("As senhas não coincidem.");
                return;
            }
            adminPassword = newPassword;
            saveData();
            alert("Senha admin alterada com sucesso!");
        }

        function changeClientPassword() {
            if (!currentClient || !clients[currentClient]) {
                alert("Erro: Nenhum cliente logado.");
                return;
            }
            const current = prompt("Digite sua senha atual:");
            if (current !== clients[currentClient].password) {
                alert("Senha atual incorreta.");
                return;
            }
            const newPassword = prompt("Digite a nova senha:");
            if (!newPassword || newPassword.trim() === "") {
                alert("A nova senha não pode ser vazia.");
                return;
            }
            const confirmPassword = prompt("Confirme a nova senha:");
            if (newPassword !== confirmPassword) {
                alert("As senhas não coincidem.");
                return;
            }
            clients[currentClient].password = newPassword;
            saveData();
            alert("Sua senha foi alterada com sucesso!");
        }

        function updateTable() {
            checkAndResetTransactions();
            resetDailyData();
            let totalWithdrawn = 0;
            DOM.clientTable.innerHTML = Object.entries(clients).map(([client, c]) => {
                totalWithdrawn += c.withdrawn;
                return `<tr><td>${client}</td><td>${c.balance.toFixed(2)}</td></tr>`;
            }).join("");
            DOM.transactionTable.innerHTML = transactions.slice().reverse().map(t => 
                `<tr><td>${t.type}</td><td>${t.client}</td><td>${t.value.toFixed(2)}</td><td>${t.source}</td><td>${t.timestamp}</td></tr>`
            ).join("");
            DOM.totalPaid.textContent = DOM.adminTotalPaid.textContent = totalWithdrawn.toFixed(2);
            saveData();
            if (currentClient) {
                updateClientPanel();
            }
            updatePendingWithdrawalsTable();
        }

        function updateClientPanel() {
            if (!currentClient || !clients[currentClient]) {
                DOM.clientPanel.style.display = "none";
                currentClient = null;
                return;
            }
            const clientData = clients[currentClient];
            DOM.clientNameDisplay.textContent = currentClient;
            DOM.clientBalance.textContent = clientData.balance.toFixed(2);
            DOM.clientWithdrawn.textContent = clientData.withdrawn.toFixed(2);
            DOM.clientTransactionTable.innerHTML = transactions
                .filter(t => t.client === currentClient)
                .slice().reverse()
                .map(t => `<tr><td>${t.type}</td><td>${t.value.toFixed(2)}</td><td>${t.source}</td><td>${t.timestamp}</td></tr>`)
                .join("");
        }

        function showAdmin() {
            if (DOM.adminPanel) {
                DOM.adminPanel.style.display = "block";
            } else {
                alert("Erro: Painel não encontrado.");
            }
        }

        function loginAdmin() {
            const password = DOM.adminPassword.value.trim();
            if (password === adminPassword) {
                DOM.adminControls.style.display = "block";
                DOM.adminPanel.style.display = "none";
                updateTable();
                updatePendingWithdrawalsTable();
                alert("Acesso autorizado.");
            } else {
                alert("Senha incorreta.");
            }
            DOM.adminPassword.value = "";
        }

        function manageClient() {
            const name = DOM.clientManage.value.trim();
            const action = DOM.clientAction.value;
            if (!name) {
                return alert("Nome inválido.");
            }
            if (action === "add") {
                if (clients[name]) {
                    return alert("Cliente já existe.");
                }
                clients[name] = { 
                    balance: 0, 
                    withdrawn: 0, 
                    dailyLoss: 0, 
                    lastDate: "", 
                    dailyOps: 0, 
                    password: name 
                };
                alert(`Cliente ${name} adicionado. Senha padrão: ${name}`);
            } else {
                if (!clients[name]) {
                    return alert("Cliente não encontrado.");
                }
                if (clients[name].balance > 0) {
                    return alert("Zere o saldo antes de excluir.");
                }
                delete clients[name];
                alert(`Cliente ${name} excluído.`);
            }
            saveData();
            updateTable();
            DOM.clientManage.value = "";
        }

        function updateBalances() {
            const hits = parseInt(DOM.hits.value) || 0;
            const misses = parseInt(DOM.misses.value) || 0;
            const today = getToday();
            const eligibleClients = Object.keys(clients).length;
            resetDailyData();
            Object.entries(clients).forEach(([client, c]) => {
                c.dailyOps += hits + misses;
                for (let i = 0; i < hits; i++) {
                    c.balance += 0.5;
                    addTransaction("Acerto", client, 0.5, "Sistema");
                }
                for (let i = 0; i < misses; i++) {
                    let loss = -1;
                    if (c.dailyLoss + Math.abs(loss) > 3) loss = -(3 - c.dailyLoss);
                    if (c.balance + loss < 0) loss = -c.balance;
                    c.balance += loss;
                    c.dailyLoss += Math.abs(loss);
                    addTransaction("Erro", client, loss, "Sistema");
                }
                c.balance = Math.max(0, c.balance);
                c.lastDate = today;
            });
            if (eligibleClients) {
                if (hits + misses === 0) {
                    alert("Insira acertos ou erros.");
                } else {
                    alert(`Registrado: ${hits} acertos (+R$0,50/cliente), ${misses} erros (-R$1,00/cliente, máx. R$3/dia).`);
                }
            } else {
                alert("Nenhum cliente cadastrado.");
            }
            saveData();
            updateTable();
            DOM.hits.value = DOM.misses.value = "";
        }

        function creditBalance() {
            const client = DOM.clientName.value.trim();
            const credit = parseFloat(DOM.credit.value);
            if (!validateInput(credit, "Valor inválido.") || !clients[client]) {
                alert("Cliente ou valor inválido.");
                return;
            }
            clients[client].balance += credit;
            addTransaction("Crédito", client, credit, "Admin");
            saveData();
            updateTable();
            alert(`R$${credit.toFixed(2)} depositado para ${client}.`);
            DOM.clientName.value = DOM.credit.value = "";
        }

        function withdrawBalance() {
            const client = DOM.clientNameWithdraw.value.trim();
            const withdraw = parseFloat(DOM.withdraw.value);
            if (!validateInput(withdraw, "Valor inválido.") || !clients[client]) {
                alert("Cliente ou valor inválido.");
                return;
            }
            if (withdraw > clients[client].balance) {
                alert("Saldo insuficiente.");
                return;
            }
            clients[client].balance -= withdraw;
            clients[client].withdrawn += withdraw;
            addTransaction("Saque", client, -withdraw, "Admin");
            saveData();
            updateTable();
            alert(`Saque de R$${withdraw.toFixed(2)} realizado para ${client}.`);
            DOM.clientNameWithdraw.value = DOM.withdraw.value = "";
        }

        function loginClient() {
            const name = DOM.clientLoginName.value.trim();
            const password = DOM.clientLoginPassword.value.trim();
            if (!name || !password) {
                alert("Nome e senha são obrigatórios.");
                return;
            }
            if (!clients[name]) {
                alert("Cliente não encontrado.");
                return;
            }
            if (clients[name].password !== password) {
                alert("Senha incorreta.");
                return;
            }
            currentClient = name;
            DOM.clientPanel.style.display = "block";
            updateClientPanel();
            alert(`Bem-vindo, ${name}!`);
            DOM.clientLoginName.value = "";
            DOM.clientLoginPassword.value = "";
        }

        function logoutClient() {
            currentClient = null;
            DOM.clientPanel.style.display = "none";
            alert("Você saiu do painel.");
        }

        // Initialize
        updateTable();
        updatePendingWithdrawalsTable();
    </script>
</body>
  </html>
