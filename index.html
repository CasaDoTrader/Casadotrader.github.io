<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Casa do Trader</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
<style>:root{--bg:#0a0a1f;--card:rgba(20,20,40,.95);--cyan:#00f2ff;--gold:#FFD700;--pink:#ff00ff;--green:#00ff88;--red:#ff2d55;--text:#e0e0ff}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Rajdhani,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center;background-image:radial-gradient(circle at 20% 80%,rgba(0,242,255,.08)0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,215,0,.08)0%,transparent 50%)}.card{max-width:390px;width:90%;background:var(--card);border-radius:20px;padding:28px 20px;border:1px solid rgba(255,215,0,.25);box-shadow:0 15px 40px rgba(255,215,0,.2),0 0 30px rgba(0,242,255,.15);position:relative;overflow:hidden}.card::before{content:"";position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--cyan),var(--gold),var(--pink))}.logo{font-size:56px;font-weight:900;background:linear-gradient(45deg,var(--cyan),var(--gold),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}.title{font-size:28px;color:#fff;margin:8px 0 20px;letter-spacing:1px}.price{font-size:42px;color:var(--gold);text-shadow:0 0 15px rgba(255,215,0,.6);margin:16px 0;font-weight:800}.off{color:var(--green);font-size:20px;font-weight:700}.btn{display:block;width:100%;padding:16px;border-radius:14px;font-weight:800;font-size:18px;margin:14px 0;border:none;cursor:pointer;transition:.3s}.buy{background:#25d366;color:#fff;box-shadow:0 8px 20px rgba(37,211,100,.5)}.buy:hover{transform:scale(1.04)}.gold{background:var(--gold);color:#000}.green{background:var(--green);color:#000}.red{background:var(--red);color:#fff;font-size:14px;padding:8px}.input{width:100%;padding:14px;margin:10px 0;border-radius:12px;background:rgba(42,42,45,.9);border:1px solid rgba(255,215,0,.3);color:#fff;font-size:16px;outline:none;text-align:center}.orbit{width:90px;height:90px;margin:24px auto;position:relative}.e{position:absolute;width:14px;height:14px;border-radius:50%;background:var(--cyan);box-shadow:0 0 20px currentColor;animation:orbit 2.8s linear infinite,color 4s infinite}@keyframes orbit{0%{transform:rotate(0deg) translateX(45px)}100%{transform:rotate(360deg) translateX(45px)}}@keyframes color{0%,100%{background:var(--cyan)}25%{background:var(--pink)}50%{background:var(--green)}75%{background:var(--gold)}}table{width:100%;margin-top:12px;font-size:14px;border-collapse:collapse}th,td{padding:8px;text-align:left}th{background:rgba(42,42,45,.8)}tr:nth-child(even){background:rgba(34,34,34,.5)}.hidden{display:none}.msg{color:var(--green);margin:10px 0;min-height:24px;font-size:15px}.err{color:var(--red)}small a{color:var(--gold);text-decoration:none}small a:hover{text-decoration:underline}</style>
</head>
<body>

<div id="main" class="card">
  <div class="logo">ÁTOMOS</div>
  <div class="title">ATOMIC 2026</div>
  <div class="orbit"><div class="e"></div><div class="e" style="animation-delay:-0.9s"></div><div class="e" style="animation-delay:-1.8s"></div></div>
  <input id="nome" class="input" placeholder="Digite seu nome" autofocus>
  <input id="senhaCli" type="password" class="input" placeholder="Sua senha (opcional)">
  <button class="btn buy" id="btnEntrar">ENTRAR NA REDE</button>
  <div class="msg err" id="msg"></div>
  <p style="margin:20px 0;line-height:1.6">1 Átomo = 100 Elétrons<br><span class="off">50% DE DESCONTO</span></p>
  <div class="price">R$ 100,00</div>
  <a href="https://wa.me/558599522997?text=Quero%201%20%C3%81tomo%20ATOMIC%20por%20R$100%20(50%25%20OFF)%20%F0%9F%94%A5%F0%9F%92%A5" target="_blank" class="btn buy">COMPRAR AGORA COM O PIX</a>
  <p style="margin:20px 0;font-size:15px">Venda Mínima Entre Clientes <b>R$ 2,00</b>/elétron<br>Taxa de: <b>10%</b></p>
  <small><a href="#" id="linkAdmin">ÁREA RESTRITA</a></small>
</div>

<div id="adminLogin" class="card hidden"><h2 style="color:var(--gold)">Área Admin</h2><input id="admUser" class="input" value="adm"><input id="admPass" type="password" class="input" placeholder="Senha"><button class="btn green" id="btnLoginAdm">ENTRAR</button><div id="admMsg" class="msg err"></div></div>

<div id="painel" class="card hidden">
  <h2 style="color:var(--green)">Painel Admin</h2>
  <p>Saldo da Casa: R$ <b id="saldoAdm">0,00</b> • <a href="#" id="linkTrocarSenhaAdm" style="color:var(--cyan)">Trocar senha</a></p>
  <button class="btn gold" id="btnSacarAdm">SACAR TUDO</button>
  <hr style="margin:20px 0;border:1px solid #333">
  <h3 style="color:var(--gold)">Saques Pendentes</h3>
  <div id="saquesPendentes" style="max-height:300px;overflow:auto;padding:10px;background:rgba(20,0,0,.3);border-radius:10px"></div>
  <hr style="margin:20px 0;border:1px solid #333">
  <input id="lucroTotal" type="number" step="0.01" class="input" placeholder="Lucro total recebido (R$)">
  <button class="btn green" id="btnDistribuir">DISTRIBUIR 75%</button><div id="distMsg" class="msg"></div>
  <hr style="margin:20px 0">
  <h3>Adicionar Cliente</h3><input id="newNome" class="input" placeholder="Nome"><input id="newAtom" type="number" class="input" placeholder="Átomos"><button class="btn green" id="btnAddCliente">ADICIONAR</button>
  <h3 style="margin-top:20px">Retirar Elétrons → Loja</h3><input id="retNome" class="input" placeholder="Nome"><input id="retQtd" type="number" class="input" placeholder="Elétrons"><button class="btn red" id="btnRetirar">RETIRAR</button><div id="retMsg" class="msg err"></div>
  <h3 style="margin-top:20px">Clientes</h3><div style="max-height:200px;overflow:auto"><table id="tabela"><tr><th>Nome</th><th>Elétrons</th><th>Saldo R$</th><th></th></tr></table></div>
  <button class="btn" style="margin-top:20px" id="btnSairAdm">Sair</button>
</div>

<div id="cliente" class="card hidden"><h2 style="color:var(--cyan)">Olá, <span id="nomeCli"></span>!</h2><p>Elétrons: <b id="eletrons">0</b> | Saldo: R$ <b id="saldoCli">0,00</b></p><button class="btn green" id="btnVender">VENDER ELÉTRONS</button><button class="btn green" id="btnLoja">LOJA</button><button class="btn gold" id="btnSacarCli">SACAR SALDO</button><button class="btn" style="background:#8B00FF;color:#fff;margin-top:10px" id="btnTrocarSenhaCli">Trocar Minha Senha</button><button class="btn" style="margin-top:15px" id="btnSairCli">Sair</button></div>

<div id="venderDiv" class="card hidden"><h2>Vender Elétrons</h2><p>Você tem: <b id="temEle">0</b> elétrons</p><input id="qtdVenda" type="number" min="1" class="input" placeholder="Quantidade"><input id="precoVenda" type="number" step="0.01" min="2" class="input" placeholder="Preço por elétron (mín. 2)"><p>Total: R$ <b id="totalVenda">0,00</b></p><button class="btn green" id="btnAnunciar">ANUNCIAR</button><button class="btn" id="btnCancelarVender">Cancelar</button></div>

<div id="lojaDiv" class="card hidden"><h2 style="color:var(--green)">Loja P2P</h2><div id="listaAnuncios" style="max-height:400px;overflow:auto"></div><button class="btn" style="margin-top:15px" id="btnVoltarLoja">Voltar</button></div>

<div id="trocaSenhaAdm" class="card hidden"><h2 style="color:var(--gold)">Trocar Senha Admin</h2><input id="oldPassAdm" type="password" class="input" placeholder="Senha atual"><input id="newPassAdm1" type="password" class="input" placeholder="Nova"><input id="newPassAdm2" type="password" class="input" placeholder="Repetir"><button class="btn green" id="btnSalvarSenhaAdm">SALVAR</button><button class="btn" id="btnCancelarSenhaAdm">Cancelar</button><div id="msgSenhaAdm" class="msg err"></div></div>

<div id="trocaSenhaCli" class="card hidden"><h2 style="color:var(--cyan)">Trocar Sua Senha</h2><p><small>Deixe em branco para remover</small></p><input id="novaSenhaCli1" type="password" class="input" placeholder="Nova"><input id="novaSenhaCli2" type="password" class="input" placeholder="Repetir"><button class="btn green" id="btnSalvarSenhaCli">SALVAR</button><button class="btn" id="btnCancelarSenhaCli">Cancelar</button><div id="msgSenhaCli" class="msg"></div></div>

<!-- Firebase (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
    collection, getDocs, addDoc, onSnapshot, query, orderBy
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyARmdv2Zet_EXfUmOXpjzuafNjqZgWi4Gg",
    authDomain: "atomic-2026.firebaseapp.com",
    projectId: "atomic-2026",
    storageBucket: "atomic-2026.firebasestorage.app",
    messagingSenderId: "466342337880",
    appId: "1:466342337880:web:ec364294a86b63cdba992d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- UTIL ----------
  function h(s){ if(!s) return null; let x=0; for(let i=0;i<s.length;i++) x=(x*31+s.charCodeAt(i))|0; return x.toString(16); }
  const msg = (id, txt, err=false) => {
    const e = document.getElementById(id);
    if(e){ e.textContent = txt; e.className = 'msg' + (err ? ' err' : ''); setTimeout(()=>{ if(e) e.textContent = '' }, 5000); }
  };
  const volta = i => {
    document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
    const t=['main','adminLogin','painel','cliente','venderDiv','lojaDiv','trocaSenhaAdm','trocaSenhaCli'];
    document.getElementById(t[i])?.classList.remove('hidden');
  };
  function slug(n){ return n.trim().toLowerCase().replace(/\s+/g,'-'); }

  // ---------- FIRESTORE HELPERS ----------
  const metaRef = doc(db, 'meta', 'adm');
  const clientesCol = collection(db, 'clientes');
  const anunciosCol = collection(db, 'anuncios');
  const saquesCol = collection(db, 'saques');

  async function ensureAdminDoc(){
    const snap = await getDoc(metaRef);
    if(!snap.exists()){
      await setDoc(metaRef, { user: 'adm', pass: h('123'), saldo: 0 });
    }
  }

  async function setClienteObject(cli){
    const id = slug(cli.nome);
    await setDoc(doc(db, 'clientes', id), cli);
  }
  async function getClienteByName(nome){
    if(!nome) return null;
    const id = slug(nome);
    const d = doc(db, 'clientes', id);
    const snap = await getDoc(d);
    return snap.exists() ? snap.data() : null;
  }
  async function deleteClienteByName(nome){
    const id = slug(nome);
    await deleteDoc(doc(db, 'clientes', id));
  }

  async function addAnuncioObj(a){
    const id = String(Date.now()) + Math.floor(Math.random()*9999);
    await setDoc(doc(db, 'anuncios', id), { ...a, id });
  }
  async function updateAnuncioObj(a){
    await setDoc(doc(db, 'anuncios', a.id), a);
  }
  async function deleteAnuncioById(id){
    await deleteDoc(doc(db, 'anuncios', id));
  }

  async function addSaqueObj(s){
    const id = String(Date.now()) + Math.floor(Math.random()*9999);
    await setDoc(doc(db, 'saques', id), s);
  }
  async function deleteSaqueById(id){
    await deleteDoc(doc(db, 'saques', id));
  }

  // ---------- STATE ----------
  let user = null; // objeto do cliente atual

  // ---------- DOM bindings ----------
  document.getElementById('btnEntrar').addEventListener('click', entrar);
  document.getElementById('linkAdmin').addEventListener('click', (e)=>{ e.preventDefault(); volta(1); });
  document.getElementById('btnLoginAdm').addEventListener('click', loginAdm);
  document.getElementById('btnSairAdm').addEventListener('click', ()=>volta(0));
  document.getElementById('btnSacarAdm').addEventListener('click', sacarAdm);
  document.getElementById('btnDistribuir').addEventListener('click', distribuir);
  document.getElementById('btnAddCliente').addEventListener('click', addCliente);
  document.getElementById('btnRetirar').addEventListener('click', retirar);
  document.getElementById('btnVender').addEventListener('click', vender);
  document.getElementById('btnLoja').addEventListener('click', loja);
  document.getElementById('btnAnunciar').addEventListener('click', anunciar);
  document.getElementById('btnCancelarVender').addEventListener('click', ()=>volta(3));
  document.getElementById('btnVoltarLoja').addEventListener('click', ()=>volta(3));
  document.getElementById('btnSacarCli').addEventListener('click', sacarCli);
  document.getElementById('btnTrocarSenhaCli').addEventListener('click', ()=>volta(7));
  document.getElementById('btnSalvarSenhaCli').addEventListener('click', salvarSenhaCliente);
  document.getElementById('btnSalvarSenhaAdm').addEventListener('click', salvarSenhaAdm);
  document.getElementById('btnCancelarSenhaAdm').addEventListener('click', ()=>volta(2));
  document.getElementById('btnCancelarSenhaCli').addEventListener('click', ()=>volta(3));
  document.getElementById('btnSairCli').addEventListener('click', ()=>{ user=null; volta(0); });

  // ---------- Real-time listeners ----------
  // admin meta (user/pass/saldo)
  onSnapshot(metaRef, snap=>{
    if(!snap.exists()) return;
    const a = snap.data();
    document.getElementById('saldoAdm').textContent = (a.saldo || 0).toFixed(2);
  });

  // clientes snapshot -> atualiza tabela do admin e atualiza UI do cliente logado (se houver mudança)
  onSnapshot(query(clientesCol, orderBy('__name__')), snapshot=>{
    const tb = document.getElementById('tabela');
    tb.innerHTML = '<tr><th>Nome</th><th>Elétrons</th><th>Saldo R$</th><th></th></tr>';
    const clients = [];
    snapshot.forEach(d=>{
      const c = d.data();
      clients.push(c);
      const enc = encodeURIComponent(c.nome);
      tb.innerHTML += `<tr><td>${c.nome}</td><td>${c.eletrons||0}</td><td>${(c.saldo||0).toFixed(2)}</td><td><button class="red" data-name="${c.nome}">X</button></td></tr>`;
    });
    // attach delete handlers
    tb.querySelectorAll('button.red').forEach(btn=>{
      btn.onclick = async ()=> {
        const nome = btn.getAttribute('data-name');
        if(!confirm('Excluir cliente?')) return;
        await deleteClienteByName(nome);
      };
    });

    // if logged-in user, refresh its displayed info from Firestore
    if(user){
      const updated = clients.find(x=>x.nome.toLowerCase() === user.nome.toLowerCase());
      if(updated){
        user = updated;
        document.getElementById('nomeCli').textContent = user.nome;
        document.getElementById('eletrons').textContent = user.eletrons || 0;
        document.getElementById('saldoCli').textContent = (user.saldo || 0).toFixed(2);
      } else {
        // user removed
        user = null;
        volta(0);
      }
    }
  });

  // anuncios snapshot -> atualiza loja
  onSnapshot(query(anunciosCol, orderBy('__name__')), snapshot=>{
    const a = [];
    snapshot.forEach(d=> a.push(d.data()));
    // if loja visible, re-render
    const lista = document.getElementById('listaAnuncios');
    if(lista){
      lista.innerHTML = '';
      if(a.length === 0){
        lista.innerHTML = '<p style="color:#888">Loja vazia</p>';
      } else {
        a.forEach(x => {
          const div = document.createElement('div');
          div.style = 'background:rgba(42,42,45,.6);padding:14px;margin:8px 0;border-radius:12px;border:1px solid rgba(255,215,0,.2)';
          const btnHtml = (user && x.vendedor === user.nome)
            ? `<button class="red" data-id="${x.id}">Cancelar</button>`
            : `<button class="btn green" data-id="${x.id}">Comprar</button>`;
          div.innerHTML = `<b>${x.vendedor}</b><br>${x.qtd} × R$${(x.preco||0).toFixed(2)} → R$${(x.qtd*(x.preco||0)).toFixed(2)}<br><small style="color:#0f0">+R$${(x.lucro||0).toFixed(2)} bônus</small><div style="margin-top:10px">${btnHtml}</div>`;
          lista.appendChild(div);
        });
        // attach handlers
        lista.querySelectorAll('button').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            if(b.classList.contains('red')) await cancelar(id);
            else await comprar(id);
          };
        });
      }
    }
  });

  // saques snapshot -> atualiza painel de saques
  onSnapshot(query(saquesCol, orderBy('__name__')), snapshot=>{
    const d = document.getElementById('saquesPendentes');
    const arr = [];
    snapshot.forEach(docu => { arr.push({ id: docu.id, ...docu.data() }); });
    d.innerHTML = arr.length ? '' : '<p style="color:#888">Nenhum saque pendente</p>';
    arr.forEach(sq=>{
      d.innerHTML += `<div style="background:rgba(50,20,20,.8);padding:12px;margin:8px 0;border-radius:10px;border:1px solid #800"><b>${sq.nome}</b> → R$${(sq.valor||0).toFixed(2)}<br><small>PIX: <b>${sq.pix}</b></small><br><small>${sq.data||''}</small><br><button class="btn red" data-id="${sq.id}" style="font-size:12px;padding:6px;margin-top:8px">PAGO</button></div>`;
    });
    d.querySelectorAll('button.red').forEach(b=>{
      b.onclick = async ()=> {
        const id = b.getAttribute('data-id');
        if(!confirm('Marcar como pago?')) return;
        await deleteSaqueById(id);
      };
    });
  });

  // ---------- Functions (converted from localStorage to Firestore) ----------

  async function entrar(){
    try{
      const n = document.getElementById('nome').value.trim();
      const p = document.getElementById('senhaCli').value;
      if(!n) return msg('msg','Digite seu nome',true);
      const c = await getClienteByName(n);
      if(!c) return msg('msg','Nome não encontrado! Compre primeiro.',true);
      if(c.pass && h(p) !== c.pass) return msg('msg','Senha incorreta!',true);
      user = c;
      document.getElementById('nomeCli').textContent = user.nome;
      document.getElementById('eletrons').textContent = user.eletrons || 0;
      document.getElementById('saldoCli').textContent = (user.saldo || 0).toFixed(2);
      volta(3);
    }catch(e){ console.error(e); msg('msg','Erro: '+e.message,true); }
  }

  async function loginAdm(){
    try{
      const u = document.getElementById('admUser').value.trim();
      const p = document.getElementById('admPass').value;
      const snap = await getDoc(metaRef);
      const a = snap.exists() ? snap.data() : null;
      if(a && u === a.user && h(p) === a.pass){ await loadPainel(); volta(2); } else { msg('admMsg','Dados incorretos',true); }
    }catch(e){ console.error(e); msg('admMsg','Erro: '+e.message,true); }
  }

  async function loadPainel(){
    // tabela e saques são atualizados por snapshot; aqui força atualização visual
    const snap = await getDoc(metaRef);
    if(snap.exists()){
      const a = snap.data();
      document.getElementById('saldoAdm').textContent = (a.saldo || 0).toFixed(2);
    }
  }

  async function retirar(){
    try{
      const nome = document.getElementById('retNome').value.trim();
      const qtd = +document.getElementById('retQtd').value;
      if(!nome || !qtd) return msg('retMsg','Preencha tudo',true);
      const cli = await getClienteByName(nome);
      if(!cli) return msg('retMsg','Cliente não encontrado',true);
      if((cli.eletrons||0) < qtd) return msg('retMsg','Elétrons insuficientes',true);
      cli.eletrons = (cli.eletrons||0) - qtd;
      await setClienteObject(cli);
      await addAnuncioObj({ vendedor: 'ATOMIC', qtd: qtd, preco: 3, lucro: 0 });
      msg('retMsg', `${qtd} elétrons retirados de ${nome} e colocados na loja por R$3`, false);
      await loadPainel();
    }catch(e){ console.error(e); msg('retMsg','Erro: '+e.message,true); }
  }

  async function distribuir(){
    try{
      const total = +document.getElementById('lucroTotal').value;
      if(!total || total <= 0) return alert('Valor inválido');
      // fetch current clients and anuncios
      const clientsSnap = await getDocs(clientesCol);
      const anunciosSnap = await getDocs(anunciosCol);
      const clientes = clientsSnap.docs.map(d=>d.data());
      const anuncios = anunciosSnap.docs.map(d=>d.data());
      const totalEle = clientes.reduce((s,c)=>s+(c.eletrons||0),0) + anuncios.reduce((s,a)=>s+a.qtd,0);
      if(totalEle === 0) return alert('Sem elétrons');
      const porEle = (total * 0.75) / totalEle;
      // update clients
      for(const c of clientes){
        const emAnuncio = anuncios.filter(a=>a.vendedor===c.nome).reduce((s,a)=>s+a.qtd,0);
        c.saldo = (c.saldo||0) + ( (c.eletrons||0) - emAnuncio ) * porEle;
        await setClienteObject(c);
      }
      // update anuncios lucro
      for(const a of anuncios){
        a.lucro = (a.lucro||0) + a.qtd * porEle;
        await updateAnuncioObj(a);
      }
      const snap = await getDoc(metaRef);
      const aadm = snap.exists() ? snap.data() : { user:'adm', pass:h('123'), saldo:0 };
      aadm.saldo = (aadm.saldo || 0) + total * 0.25;
      await setDoc(metaRef, aadm);
      msg('distMsg', `Distribuído! Casa +R$${(total*0.25).toFixed(2)}`);
      document.getElementById('lucroTotal').value = '';
      await loadPainel();
    }catch(e){ console.error(e); alert('Erro: '+e.message); }
  }

  async function comprar(id){
    try{
      // read all anuncios and find by id (snapshot keeps them updated)
      const aSnap = await getDocs(anunciosCol);
      const anuncios = aSnap.docs.map(d=>d.data());
      const a = anuncios.find(x=>x.id===id);
      if(!a || (user && a.vendedor === user.nome)) return;
      const qtd = +prompt(`Quantos (máx ${a.qtd})?`, a.qtd) || 0;
      if(qtd < 1 || qtd > a.qtd) return alert('Quantidade inválida');
      const total = qtd * a.preco;
      const bonus = a.qtd ? (qtd * (a.lucro || 0) / a.qtd) : 0;
      if((user.saldo || 0) < total) return alert('Saldo insuficiente');

      // update buyer
      user.saldo = (user.saldo || 0) - total + bonus;
      user.eletrons = (user.eletrons || 0) + qtd;
      await setClienteObject(user);

      if(a.vendedor === 'ATOMIC'){
        const snap = await getDoc(metaRef);
        const casa = snap.exists() ? snap.data() : { user:'adm', pass:h('123'), saldo:0 };
        casa.saldo = (casa.saldo || 0) + total;
        await setDoc(metaRef, casa);
      } else {
        const vendedor = await getClienteByName(a.vendedor);
        if(vendedor){
          vendedor.saldo = (vendedor.saldo || 0) + (total * 0.9);
          await setClienteObject(vendedor);
        }
        const snap = await getDoc(metaRef);
        const casa = snap.exists() ? snap.data() : { user:'adm', pass:h('123'), saldo:0 };
        casa.saldo = (casa.saldo || 0) + (total * 0.1);
        await setDoc(metaRef, casa);
      }

      // update anuncio
      a.qtd -= qtd;
      a.lucro = (a.lucro || 0) - bonus;
      if(a.qtd <= 0) await deleteAnuncioById(a.id); else await updateAnuncioObj(a);

      document.getElementById('eletrons').textContent = user.eletrons;
      document.getElementById('saldoCli').textContent = (user.saldo||0).toFixed(2);
      alert(`Comprado! +${qtd} elétrons\n+Bônus R$${bonus.toFixed(2)}`);
      await loja();
    }catch(e){ console.error(e); alert('Erro compra: '+e.message); }
  }

  async function cancelar(id){
    try{
      if(!confirm('Cancelar?')) return;
      const aSnap = await getDocs(anunciosCol);
      const anuncios = aSnap.docs.map(d=>d.data());
      const a = anuncios.find(x=>x.id===id);
      if(!a) return;
      // give back elétrons and lucro to user
      const cli = await getClienteByName(user.nome);
      if(cli){
        cli.eletrons = (cli.eletrons || 0) + a.qtd;
        cli.saldo = (cli.saldo || 0) + (a.lucro || 0);
        await setClienteObject(cli);
      }
      await deleteAnuncioById(id);
      await loja();
    }catch(e){ console.error(e); alert('Erro: '+e.message); }
  }

  async function loja(){
    // rendering handled by snapshot; just ensure view switch
    volta(5);
  }

  async function anunciar(){
    try{
      const q = +document.getElementById('qtdVenda').value;
      const p = +document.getElementById('precoVenda').value;
      if(q < 1 || q > (user.eletrons || 0) || p < 2) return alert('Erro');
      user.eletrons -= q;
      await setClienteObject(user);
      await addAnuncioObj({ vendedor: user.nome, qtd: q, preco: p, lucro: 0 });
      alert('Anunciado!');
      volta(3);
    }catch(e){ console.error(e); alert('Erro anunciar: '+e.message); }
  }

  function vender(){
    document.getElementById('temEle').textContent = user.eletrons||0;
    document.getElementById('qtdVenda').max = user.eletrons||0;
    const calc = () => document.getElementById('totalVenda').textContent = ((+document.getElementById('qtdVenda').value||0)*(+document.getElementById('precoVenda').value||0)).toFixed(2);
    document.getElementById('qtdVenda').oninput = calc;
    document.getElementById('precoVenda').oninput = calc;
    volta(4);
  }

  async function sacarCli(){
    try{
      if((user.saldo || 0) <= 0) return alert('Sem saldo');
      const pix = prompt(`Sacando R$${(user.saldo||0).toFixed(2)}\nChave Pix:`);
      if(pix && pix.trim()){
        await addSaqueObj({ nome: user.nome, valor: user.saldo, pix: pix.trim(), data: new Date().toLocaleString('pt-BR') });
        user.saldo = 0;
        await setClienteObject(user);
        document.getElementById('saldoCli').textContent = '0.00';
        alert('Saque solicitado!');
        volta(3);
      }
    }catch(e){ console.error(e); alert('Erro saque: '+e.message); }
  }

  async function addCliente(){
    try{
      const n = document.getElementById('newNome').value.trim();
      const a = +document.getElementById('newAtom').value;
      if(!n || !a) return alert('Preencha');
      const exists = await getClienteByName(n);
      if(exists) return alert('Já existe');
      const cli = { nome: n, eletrons: a * 100, saldo: 0, pass: null };
      await setClienteObject(cli);
      document.getElementById('newNome').value = '';
      document.getElementById('newAtom').value = '';
      // table will update via snapshot
    }catch(e){ console.error(e); alert('Erro addCliente: '+e.message); }
  }

  async function delCliByIndexName(indexName){
    // not used now because admin deletes by name via snapshot buttons
  }

  async function sacarAdm(){
    try{
      const snap = await getDoc(metaRef);
      const a = snap.exists() ? snap.data() : null;
      if(!a || (a.saldo || 0) <= 0) return alert('Sem saldo');
      if(confirm(`Sacar R$${(a.saldo||0).toFixed(2)}?`)){
        a.saldo = 0;
        await setDoc(metaRef, a);
        alert('Sacado!');
      }
    }catch(e){ console.error(e); alert('Erro sacarAdm: '+e.message); }
  }

  async function salvarSenhaAdm(){
    try{
      const o = document.getElementById('oldPassAdm').value;
      const n1 = document.getElementById('newPassAdm1').value;
      const n2 = document.getElementById('newPassAdm2').value;
      const snap = await getDoc(metaRef);
      const a = snap.exists() ? snap.data() : null;
      if(!a) return msg('msgSenhaAdm','Erro admin',true);
      if(h(o) !== a.pass) return msg('msgSenhaAdm','Senha atual errada',true);
      if(n1 !== n2) return msg('msgSenhaAdm','Senhas não coincidem',true);
      if(n1 && n1.length < 3) return msg('msgSenhaAdm','Mínimo 3 caracteres',true);
      a.pass = h(n1);
      await setDoc(metaRef, a);
      msg('msgSenhaAdm','Senha alterada!');
      setTimeout(()=>volta(2),2000);
    }catch(e){ console.error(e); msg('msgSenhaAdm','Erro: '+e.message,true); }
  }

  async function salvarSenhaCliente(){
    try{
      const s1 = document.getElementById('novaSenhaCli1').value;
      const s2 = document.getElementById('novaSenhaCli2').value;
      if(s1 !== s2) return msg('msgSenhaCli','Senhas não coincidem',true);
      if(s1 && s1.length < 3) return msg('msgSenhaCli','Mínimo 3 caracteres',true);
      user.pass = s1 ? h(s1) : null;
      await setClienteObject(user);
      msg('msgSenhaCli', s1 ? 'Senha alterada!' : 'Senha removida!');
      setTimeout(()=>volta(3),2000);
    }catch(e){ console.error(e); msg('msgSenhaCli','Erro: '+e.message,true); }
  }

  // ---------- init ----------
  (async function init(){
    try{
      await ensureAdminDoc();
      // ensure at least one anuncio ATOMIC exists
      const snap = await getDocs(anunciosCol);
      if(snap.empty){
        await addAnuncioObj({ vendedor: 'ATOMIC', qtd: 1000, preco: 3, lucro: 0 });
      }
    }catch(e){ console.error('init err', e); msg('msg','Erro init: '+(e.message||e), true); }
  })();

</script>

</body>
</html>
